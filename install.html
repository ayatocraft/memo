<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA インストールアシスタント</title>
    
    <link rel="stylesheet" href="style.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ayatocraft/memo@main/style.css">
    <link rel="manifest" href="manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PWA アシスタント">
</head>
<body class="install-page">

<div class="assistant-container">
    <h1 id="assistantTitle">PWA アシスタント</h1>
    <p id="assistantMessage">状態を確認しています...</p>

    <div id="buttonContainer"></div>

    <button id="cancelBtn" class="pwa-button cancel-btn">キャンセル (ホームに戻る)</button>

    <p id="message" style="display:none;"></p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const buttonContainer = document.getElementById('buttonContainer');
    const messageEl = document.getElementById('message');
    const titleEl = document.getElementById('assistantTitle');
    const msgEl = document.getElementById('assistantMessage');
    let installPromptEvent = null;

    // Service Worker 登録
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed:', err));
    }

    // PWAインストール済みかチェック
    const isPwaInstalled = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    // --- 関数定義 ---

    function showUninstallUI() {
        titleEl.textContent = 'PWAをアンインストール';
        msgEl.innerHTML = 'アプリはインストール済みです。<br>アンインストールはブラウザまたはOSの設定から手動で行う必要があります。';
        buttonContainer.innerHTML = '';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'instructions';
        infoDiv.innerHTML = `
            <p><strong>一般的なアンインストール手順:</strong></p>
            <p><strong>PC (Chrome) の場合:</strong><br>
            1. アドレスバーに <code>chrome://apps</code> と入力<br>
            2. 「メモアプリ」を右クリック<br>
            3. 「Chrome から削除」を選択</p>
            <p><strong>スマートフォンの場合:</strong><br>
            ホーム画面のアプリアイコンを長押しし、「アンインストール」または「アプリを削除」を選択してください。</p>
        `;
        buttonContainer.appendChild(infoDiv);

        const uninstallBtn = document.createElement('button');
        uninstallBtn.textContent = '手順を理解しました (ホームに戻る)';
        uninstallBtn.className = 'pwa-button uninstall-btn';
        uninstallBtn.addEventListener('click', () => window.location.href='home.html');
        buttonContainer.appendChild(uninstallBtn);
    }

    function showInstallUI() {
        titleEl.textContent = 'PWAをインストール';
        buttonContainer.innerHTML = '';

        const installBtn = document.createElement('button');
        installBtn.id = 'installActionBtn';
        installBtn.textContent = 'インストール';
        installBtn.className = 'pwa-button install-btn';
        installBtn.disabled = true; // プロンプト準備中は押せない

        msgEl.textContent = 'インストールの準備をしています... (プロンプト待機中)';

        installBtn.addEventListener('click', async () => {
            if (!installPromptEvent) return;

            installBtn.disabled = true;
            installPromptEvent.prompt();

            const { outcome } = await installPromptEvent.userChoice;
            if (outcome === 'accepted') {
                messageEl.textContent = 'インストールが完了しました。ホームに戻ります。';
                setTimeout(() => window.location.href='home.html', 2000);
            } else {
                messageEl.textContent = 'インストールがキャンセルされました。';
                installBtn.disabled = false;
            }
            installPromptEvent = null;
            messageEl.style.display = 'block';
        });

        buttonContainer.appendChild(installBtn);
    }

    // --- メイン処理 ---
    if (isPwaInstalled) {
        showUninstallUI();
    } else {
        showInstallUI();

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            installPromptEvent = e;
            const installBtn = document.getElementById('installActionBtn');
            if (installBtn) {
                installBtn.disabled = false;
                msgEl.textContent = '準備ができました。下のボタンを押してインストールしてください。';
            }
        });

        setTimeout(() => {
            if (!installPromptEvent && !isPwaInstalled) {
                const installBtn = document.getElementById('installActionBtn');
                if (installBtn && installBtn.disabled) {
                    msgEl.textContent = 'PWAインストールに対応していないか、過去にインストールを拒否した可能性があります。';
                    installBtn.textContent = '利用不可';
                }
            }
        }, 3000);
    }

    // キャンセルボタン
    document.getElementById('cancelBtn').addEventListener('click', () => window.location.href='home.html');
});
</script>

</body>
</html>
