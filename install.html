<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</title>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ayatocraft/memo@main/style.css">

    <link rel="manifest" href="manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PWA ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ">
    
    <style>
        /* (å‰å›ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«ã®ãŸã‚çœç•¥) */
        .assistant-container {
            padding: 20px;
            background-color: var(--color-bg-secondary); 
            border-radius: 8px;
            max-width: 600px;
            margin: 0 auto;
        }
        .assistant-container .backup-btn {
            margin-top: 15px;
            width: 100%;
        }
        .instructions {
            background-color: var(--color-bg);
            border: 1px solid var(--color-border);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: left;
        }
        .instructions p { margin-bottom: 10px; }
        .instructions code {
            background-color: var(--color-bg-tertiary);
            padding: 2px 5px;
            border-radius: 3px;
        }
        .cancel-btn {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .cancel-btn:hover { background-color: #5a6268; }
        .install-btn {
             background-color: #28a745; 
             border-color: #28a745;
        }
        .install-btn:hover { background-color: #218838; }
        .install-btn:disabled {
            background-color: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
            color: #666;
        }
        #message {
            margin-top: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">

    <aside class="sidebar">
        <h2>Memo</h2>
        <nav>
            <a href="home.html" class="backup-btn" style="text-decoration: none; margin-top: 20px; display: block; text-align: center;">
                ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
            </a>
        </nav>
    </aside>

    <main class="content">
        <div class="assistant-container">
            <h1 id="assistantTitle" style="text-align: center;">PWA ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h1>
            <p id="assistantMessage" style="text-align: center;">çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...</p>
            <div id="buttonContainer"></div>
            <button id="cancelBtn" class="backup-btn cancel-btn" style="margin-top: 20px; width: 100%;">ã‚­ãƒ£ãƒ³ã‚»ãƒ« (ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹)</button>
            <p id="message" style="display:none; text-align: center;"></p>
        </div>
    </main>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const buttonContainer = document.getElementById('buttonContainer');
    const messageEl = document.getElementById('message');
    const titleEl = document.getElementById('assistantTitle');
    const msgEl = document.getElementById('assistantMessage');
    let installPromptEvent = null;

    // Service Worker ç™»éŒ²
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed:', err));
    }

    // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
    // â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ â–¼â–¼â–¼
    // ã€Œãƒ–ãƒ©ã‚¦ã‚¶ãƒ¢ãƒ¼ãƒ‰ã§"ãªã„"ã€å ´åˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã¨åˆ¤å®šã™ã‚‹
    const isPwaInstalled = !window.matchMedia('(display-mode: browser)').matches || window.navigator.standalone;
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    // --- é–¢æ•°å®šç¾© (showUninstallUI, showInstallUI) ---
    // (ä¸­èº«ã¯å‰å›ã¨åŒä¸€ã®ãŸã‚ã€å¤‰æ›´ãªã—)

    function showUninstallUI() {
        titleEl.textContent = 'PWAã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«';
        msgEl.innerHTML = 'ã‚¢ãƒ—ãƒªã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã™ã€‚<br>ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã¾ãŸã¯OSã®è¨­å®šã‹ã‚‰æ‰‹å‹•ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚';
        buttonContainer.innerHTML = '';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'instructions'; 
        infoDiv.innerHTML = `
            <p><strong>ä¸€èˆ¬çš„ãªã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †:</strong></p>
            <p><strong>PC (Chrome) ã®å ´åˆ:</strong><br>
            1. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã« <code>chrome://apps</code> ã¨å…¥åŠ›<br>
            2. ã€Œãƒ¡ãƒ¢ã‚¢ãƒ—ãƒªã€ã‚’å³ã‚¯ãƒªãƒƒã‚¯<br>
            3. ã€ŒChrome ã‹ã‚‰å‰Šé™¤ã€ã‚’é¸æŠ</p>
            <p><strong>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®å ´åˆ:</strong><B<br>
            ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³ã‚’é•·æŠ¼ã—ã—ã€ã€Œã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã¾ãŸã¯ã€Œã‚¢ãƒ—ãƒªã‚’å‰Šé™¤ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
        `;
        buttonContainer.appendChild(infoDiv);

        const uninstallBtn = document.createElement('button');
        uninstallBtn.textContent = 'æ‰‹é †ã‚’ç†è§£ã—ã¾ã—ãŸ (ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹)';
        uninstallBtn.className = 'backup-btn'; 
        uninstallBtn.addEventListener('click', () => window.location.href='home.html');
        buttonContainer.appendChild(uninstallBtn);

        const originalCancelBtn = document.getElementById('cancelBtn');
        if (originalCancelBtn) {
            originalCancelBtn.style.display = 'none';
        }
    }

    function showInstallUI() {
        titleEl.textContent = 'PWAã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«';
        buttonContainer.innerHTML = '';

        const installBtn = document.createElement('button');
        installBtn.id = 'installActionBtn';
        installBtn.textContent = 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«';
        installBtn.className = 'backup-btn install-btn'; 
        installBtn.disabled = true; 
        msgEl.textContent = 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®æº–å‚™ã‚’ã—ã¦ã„ã¾ã™... (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¾…æ©Ÿä¸­)';

        installBtn.addEventListener('click', async () => {
            if (!installPromptEvent) return;

            installBtn.disabled = true;
            installPromptEvent.prompt();

            const { outcome } = await installPromptEvent.userChoice;
            if (outcome === 'accepted') {
                messageEl.textContent = 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã€‚';
                const originalCancelBtn = document.getElementById('cancelBtn');
                if (originalCancelBtn) originalCancelBtn.style.display = 'none';
                
                setTimeout(() => window.location.href='home.html', 2000);
            } else {
                messageEl.textContent = 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚';
                installBtn.disabled = false;
            }
            installPromptEvent = null;
            messageEl.style.display = 'block';
        });

        buttonContainer.appendChild(installBtn);
    }

    // --- ãƒ¡ã‚¤ãƒ³å‡¦ç† (å¤‰æ›´ãªã—) ---
    if (isPwaInstalled) {
        showUninstallUI();
    } else {
        showInstallUI();

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            installPromptEvent = e;
            const installBtn = document.getElementById('installActionBtn');
            if (installBtn) {
                installBtn.disabled = false;
                msgEl.textContent = 'æº–å‚™ãŒã§ãã¾ã—ãŸã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚';
            }
        });

        setTimeout(() => {
            if (!installPromptEvent && !isPwaInstalled) {
                const installBtn = document.getElementById('installActionBtn');
                if (installBtn && installBtn.disabled) {
                    msgEl.textContent = 'PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¯¾å¿œã—ã¦ã„ãªã„ã‹ã€éå»ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ‹’å¦ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                    installBtn.textContent = 'åˆ©ç”¨ä¸å¯';
                }
            }
        }, 3000);
    }

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (å¤‰æ›´ãªã—)
    document.getElementById('cancelBtn').addEventListener('click', () => window.location.href='home.html');
});
</script>

</body>
</html>
