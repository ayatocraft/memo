<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è»¢é€ - ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒª</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
body {
    font-family: "Segoe UI", "Noto Sans JP", sans-serif;
    margin:0; padding:20px;
    background:#f3f4f6;
    color: #333;
}
.container {
    max-width:700px;
    margin:0 auto;
    background:white;
    padding:20px 30px 60px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    position: relative;
}
h1 { 
    text-align:center; 
    color: #111;
    margin-top: 0;
}
.mode-section { 
    display:flex; 
    gap:10px; 
    justify-content:center; 
    margin-bottom:20px; 
    flex-wrap:wrap; 
}
.mode-section button { 
    flex:1 1 45%; 
    min-width:140px; 
    padding:12px; 
    font-size:16px; 
    font-weight: 500;
    cursor:pointer; 
    border:none; 
    border-radius:8px; 
    background:#0078D7; 
    color:white; 
    transition: background-color 0.2s;
}
.mode-section button:hover { background:#005fa3; }

.section { 
    display:none; 
    margin-top:20px; 
    padding:20px; 
    border-radius:10px; 
    background:#f9fafb;
    border: 1px solid #e5e7eb;
}
.section h2 {
    margin-top: 0;
    text-align: center;
    color: #333;
}

.status { 
    margin-top:20px; 
    padding:10px 15px; 
    border-radius:6px; 
    background:#eee; 
    font-size:14px; 
    text-align: center;
    word-wrap: break-word;
}
#myPeerIdContainer { 
    display:flex; 
    gap:10px; 
    align-items:center; 
    margin-bottom:15px; 
    flex-wrap:wrap; 
    justify-content: center;
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
}
#myPeerId { 
    font-weight:bold; 
    font-size: 1.1em;
    color: #005fa3;
    word-break: break-all;
}
button.copyBtn { 
    background:#4CAF50; 
    color:white; 
    padding:6px 10px; 
    font-size:14px; 
    border-radius:4px; 
    border:none; 
    cursor:pointer; 
}
button.copyBtn:hover { background:#357a38; }

input[type="text"] { 
    width: 100%; 
    padding: 8px 10px; 
    margin-top: 6px; 
    border-radius: 6px; 
    border: 1px solid #ccc; 
    font-size: 14px; 
    box-sizing: border-box; 
    margin-bottom: 15px;
}

#connectBtn, .action-btn {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    border-radius: 8px;
    color: white;
    margin-top: 10px;
    transition: background-color 0.2s;
}

#connectBtn { background: #0078D7; }
#connectBtn:hover { background: #005fa3; }

#downloadBackupBtn { background: #28a745; }
#downloadBackupBtn:hover { background: #218838; }

#loadFromFileBtn { background: #17a2b8; }
#loadFromFileBtn:hover { background: #138496; }

/* ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ */
#homeBtn {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: #6c757d;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
    transition: background-color 0.2s;
}
#homeBtn:hover {
    background: #5a6268;
}
</style>
</head>
<body>

<div class="container">
    <h1>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è»¢é€</h1>

    <div class="mode-section">
        <button id="sendModeBtn">é€ä¿¡ãƒ¢ãƒ¼ãƒ‰</button>
        <button id="receiveModeBtn">å—ä¿¡ãƒ¢ãƒ¼ãƒ‰</button>
    </div>

    <div id="sendMode" class="section">
        <h2>é€ä¿¡ãƒ¢ãƒ¼ãƒ‰</h2>
        <p>1. å—ä¿¡å´ã§ã€Œå—ä¿¡ãƒ¢ãƒ¼ãƒ‰ã€ã‚’é¸æŠã—ã€è¡¨ç¤ºã•ã‚ŒãŸã€Œè‡ªåˆ†ã®IDã€ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚</p>
        <p>2. ä¸‹ã®å…¥åŠ›æ¬„ã«ã€å—ä¿¡å´ã®IDã‚’è²¼ã‚Šä»˜ã‘ã¦ã€Œæ¥ç¶šã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
        <input type="text" id="remotePeerId" placeholder="å—ä¿¡å´ã®IDã‚’å…¥åŠ›">
        <button id="connectBtn">æ¥ç¶šã—ã¦é€ä¿¡</button>

        <hr style="border: 0; border-top: 1px solid #ddd; margin: 25px 0;">
        <p style="text-align:center; margin-bottom: 10px;">ã¾ãŸã¯ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚</p>
        <button id="downloadBackupBtn" class="action-btn">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <div id="receiveMode" class="section">
        <h2>å—ä¿¡ãƒ¢ãƒ¼ãƒ‰</h2>
        <p>1. ä¸‹ã«è¡¨ç¤ºã•ã‚Œã‚‹ã€Œè‡ªåˆ†ã®IDã€ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€é€ä¿¡å´ã«ä¼ãˆã¦ãã ã•ã„ã€‚</p>
        <p>2. é€ä¿¡å´ãŒæ¥ç¶šã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ãŒå—ä¿¡ã•ã‚Œã¾ã™ã€‚</p>

        <div id="myPeerIdContainer">
            ID: <span id="myPeerId">å–å¾—ä¸­...</span>
            <button class="copyBtn" id="copyBtn">ã‚³ãƒ”ãƒ¼</button>
        </div>

        <hr style="border: 0; border-top: 1px solid #ddd; margin: 25px 0;">
        <p style="text-align:center; margin-bottom: 10px;">ã¾ãŸã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã€‚</p>
        <input type="file" id="backupFileInput" accept=".json" style="display:none;">
        <button id="loadFromFileBtn" class="action-btn">ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</button>
    </div>

    <div id="status" class="status">ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</div>

    <button id="homeBtn">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
</div>

<script>
window.onload = () => {
    const sendModeBtn = document.getElementById('sendModeBtn');
    const receiveModeBtn = document.getElementById('receiveModeBtn');
    const sendMode = document.getElementById('sendMode');
    const receiveMode = document.getElementById('receiveMode');
    const myPeerId = document.getElementById('myPeerId');
    const copyBtn = document.getElementById('copyBtn');
    const remotePeerId = document.getElementById('remotePeerId');
    const connectBtn = document.getElementById('connectBtn');
    const status = document.getElementById('status');
    const downloadBackupBtn = document.getElementById('downloadBackupBtn');
    const loadFromFileBtn = document.getElementById('loadFromFileBtn');
    const backupFileInput = document.getElementById('backupFileInput');
    const homeBtn = document.getElementById('homeBtn');

    let peer = null;

    sendModeBtn.onclick = () => {
        sendMode.style.display = 'block';
        receiveMode.style.display = 'none';
        status.textContent = 'é€ä¿¡ãƒ¢ãƒ¼ãƒ‰ã€‚å—ä¿¡å´ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        initializePeer();
    };

    receiveModeBtn.onclick = () => {
        sendMode.style.display = 'none';
        receiveMode.style.display = 'block';
        status.textContent = 'å—ä¿¡ãƒ¢ãƒ¼ãƒ‰ã€‚Peer IDã‚’å–å¾—ä¸­ã§ã™...';
        myPeerId.textContent = 'å–å¾—ä¸­...';
        initializePeer();
    };

    function initializePeer() {
        if (peer) peer.destroy();

        // PeerJSå…¬å¼ã‚µãƒ¼ãƒãƒ¼ + ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        try {
            peer = new Peer({
                debug: 2,
                config: {
                    iceServers: [
                        { urls: "stun:stun.l.google.com:19302" },
                        { urls: "stun:stun1.l.google.com:19302" }
                    ]
                }
            });
        } catch (e) {
            console.error("Peer init error:", e);
            alert("PeeråˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            return;
        }

        peer.on('open', id => {
            if (!id) {
                status.textContent = "Peer IDã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚";
                myPeerId.textContent = "å–å¾—å¤±æ•—";
                return;
            }
            if (receiveMode.style.display === 'block') {
                myPeerId.textContent = id;
                status.textContent = 'å—ä¿¡å¾…æ©Ÿä¸­ã€‚ä¸Šè¨˜ã®IDã‚’é€ä¿¡å´ã«ä¼ãˆã¦ãã ã•ã„ã€‚';
            }
        });

        peer.on('connection', conn => {
            status.textContent = 'æ¥ç¶šã•ã‚Œã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿å—ä¿¡ä¸­...';
            conn.on('data', data => {
                try {
                    restoreFromBackup(data);
                    status.textContent = 'ãƒ‡ãƒ¼ã‚¿å—ä¿¡å®Œäº†ã€‚';
                    alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸã€‚');
                } catch (e) {
                    alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
                    status.textContent = 'å¾©å…ƒå¤±æ•—';
                }
            });
        });

        peer.on('error', err => {
            console.error(err);
            status.textContent = "P2Pã‚¨ãƒ©ãƒ¼: " + err.type;
            myPeerId.textContent = "å–å¾—å¤±æ•—";
        });
    }

    connectBtn.onclick = () => {
        if (!peer || peer.destroyed) {
            status.textContent = 'PeerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¢ãƒ¼ãƒ‰ã‚’å†åº¦é¸æŠã—ã¦ãã ã•ã„ã€‚';
            return;
        }
        const remoteId = remotePeerId.value.trim();
        if (!remoteId) {
            alert('å—ä¿¡å´ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const conn = peer.connect(remoteId);
        status.textContent = 'æ¥ç¶šä¸­...';
        conn.on('open', () => {
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('memoapp_')) {
                    allData[key] = localStorage.getItem(key);
                }
            }
            if (Object.keys(allData).length === 0) {
                alert('é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                status.textContent = 'é€ä¿¡ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚';
                return;
            }
            conn.send(allData);
            status.textContent = 'ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº†ã€‚';
            alert('ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚');
        });
    };

    copyBtn.onclick = () => {
        const text = myPeerId.textContent;
        if (!text || text.includes('å–å¾—')) {
            alert('ã¾ã IDã‚’å–å¾—ã—ã¦ã„ã¾ã›ã‚“ã€‚');
            return;
        }
        navigator.clipboard.writeText(text);
        alert('IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
    };

    function restoreFromBackup(data) {
        if (typeof data !== 'object') throw new Error('ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿å½¢å¼');
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('memoapp_')) localStorage.removeItem(key);
        }
        for (const key in data) {
            if (key.startsWith('memoapp_')) {
                localStorage.setItem(key, data[key]);
            }
        }
    }

    downloadBackupBtn.onclick = () => {
        const allData = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('memoapp_')) allData[key] = localStorage.getItem(key);
        }
        if (Object.keys(allData).length === 0) {
            alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const d = new Date();
        const fname = `memo_backup_${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}_${d.getHours()}${d.getMinutes()}.json`;
        a.href = url;
        a.download = fname;
        a.click();
        URL.revokeObjectURL(url);
        status.textContent = 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚';
    };

    loadFromFileBtn.onclick = () => backupFileInput.click();
    backupFileInput.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            const data = JSON.parse(ev.target.result);
            restoreFromBackup(data);
            alert('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸã€‚');
        };
        reader.readAsText(file);
    };

    homeBtn.onclick = () => {
        window.location.href = "index.html";
    };
};
</script>
</body>
</html>
