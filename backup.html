<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è»¢é€ - ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒª</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/ably/browser/static/ably.min.js"></script>
<style>
body { font-family: "Segoe UI", "Noto Sans JP", sans-serif; background:#f3f4f6; margin:0; padding:0; }
.container { max-width:800px; margin:40px auto; background:#fff; padding:24px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.1); }
h1 { text-align:center; margin-bottom:20px; }
.mode { display:flex; justify-content:center; gap:20px; margin-bottom:20px; }
button { padding:10px 16px; border:none; border-radius:8px; background:#0078d7; color:#fff; cursor:pointer; transition:0.2s; }
button:hover { background:#005fa3; }
button.secondary { background:#ccc; color:#000; }
.hidden { display:none; }
.section { background:#f9fafb; border-radius:12px; padding:20px; margin-top:10px; }
.status { margin-top:10px; padding:8px; border-radius:8px; background:#eee; font-size:14px; }
.status.ok { background:#d1fae5; color:#065f46; }
.status.wait { background:#fef3c7; color:#92400e; }
.status.err { background:#fee2e2; color:#991b1b; }
.info-btn { position:absolute; top:10px; right:10px; font-size:22px; background:transparent; color:#666; cursor:pointer; }
#infoModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; }
#infoContent { background:#fff; padding:20px; border-radius:12px; max-width:500px; line-height:1.6; }
#infoContent h2 { margin-top:0; }
#infoContent button { background:#0078d7; color:#fff; float:right; }
input[type="text"], input[type="file"] { width:100%; padding:8px; margin-top:4px; margin-bottom:8px; border-radius:4px; border:1px solid #ccc; }
</style>
</head>
<body>
<div class="container">
  <button class="info-btn" id="infoBtn">â„¹ï¸</button>
  <h1>ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è»¢é€</h1>

  <div class="mode">
    <button id="sendModeBtn">ğŸ“¤ é€ä¿¡ãƒ¢ãƒ¼ãƒ‰</button>
    <button id="receiveModeBtn">ğŸ“¥ å—ä¿¡ãƒ¢ãƒ¼ãƒ‰</button>
  </div>

  <div id="sendSection" class="section hidden">
    <h2>é€ä¿¡ãƒ¢ãƒ¼ãƒ‰</h2>
    <p>å—ä¿¡å´ã®PeerIDã‚’å…¥åŠ›ã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’é€ä¿¡ã—ã¾ã™ã€‚</p>
    <input type="text" id="targetPeerId" placeholder="å—ä¿¡å´PeerID">
    <button id="sendBackupBtn">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆï¼†é€ä¿¡</button>
    <div id="sendStatus" class="status"></div>
  </div>

  <div id="receiveSection" class="section hidden">
    <h2>å—ä¿¡ãƒ¢ãƒ¼ãƒ‰</h2>
    <p>è‡ªåˆ†ã®PeerIDã¯ä»¥ä¸‹ã§ã™ï¼ˆé€ä¿¡å´ã«ä¼ãˆã¦ãã ã•ã„ï¼‰ï¼š <b id="myPeerId">ç”Ÿæˆä¸­...</b></p>
    <div id="receiveStatus" class="status"></div>
    <div id="receivedFileArea" class="hidden">
      <p>å—ä¿¡å®Œäº†: <b id="receivedFileName"></b></p>
      <button id="loadBackup">èª­ã¿è¾¼ã¿</button>
    </div>
    <hr>
    <p>ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼š</p>
    <input type="file" id="localFile">
  </div>

  <div style="text-align:center;margin-top:20px;">
    <button class="secondary" onclick="window.location.href='home.html'">ğŸ  ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
  </div>
</div>

<!-- Info Modal -->
<div id="infoModal">
  <div id="infoContent">
    <h2>â„¹ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è»¢é€ã®ä½¿ã„æ–¹</h2>
    <ul>
      <li>é€ä¿¡ãƒ¢ãƒ¼ãƒ‰ï¼šå—ä¿¡å´ã®PeerIDã‚’å…¥åŠ› â†’ ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆï¼†é€ä¿¡ã€ã‚’æŠ¼ã™ã€‚</li>
      <li>å—ä¿¡ãƒ¢ãƒ¼ãƒ‰ï¼šè‡ªåˆ†ã®PeerIDã‚’é€ä¿¡å´ã«ä¼ãˆã€é€ä¿¡ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤ã€‚</li>
      <li>å—ä¿¡å®Œäº†å¾Œã€Œèª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³ã§ãƒ¡ãƒ¢ã‚’å¾©å…ƒã€‚</li>
      <li>ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚‚å¯èƒ½ã€‚</li>
      <li>Wi-FiãŒç•°ãªã£ã¦ã„ã¦ã‚‚Ablyã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é€ä¿¡å¯èƒ½ã€‚</li>
    </ul>
    <button id="closeInfo">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const ably = new Ably.Realtime("m4nEkQ.t_3fkw:CyxgDJS1Z5J8b6FAiCxkO1F-t7cLQGIxmfin9BzL");

// UI Elements
const sendModeBtn = document.getElementById("sendModeBtn");
const receiveModeBtn = document.getElementById("receiveModeBtn");
const sendSection = document.getElementById("sendSection");
const receiveSection = document.getElementById("receiveSection");
const myPeerIdEl = document.getElementById("myPeerId");
const sendStatus = document.getElementById("sendStatus");
const receiveStatus = document.getElementById("receiveStatus");
const targetPeerIdInput = document.getElementById("targetPeerId");
const sendBackupBtn = document.getElementById("sendBackupBtn");
const receivedFileArea = document.getElementById("receivedFileArea");
const receivedFileName = document.getElementById("receivedFileName");
const loadBackupBtn = document.getElementById("loadBackup");
const localFileInput = document.getElementById("localFile");
let receivedData = null;

// Mode toggle
sendModeBtn.onclick = () => { sendSection.classList.remove("hidden"); receiveSection.classList.add("hidden"); };
receiveModeBtn.onclick = () => { receiveSection.classList.remove("hidden"); sendSection.classList.add("hidden"); };

// Info modal
const infoBtn = document.getElementById("infoBtn");
const infoModal = document.getElementById("infoModal");
const closeInfo = document.getElementById("closeInfo");
infoBtn.onclick = () => infoModal.style.display = "flex";
closeInfo.onclick = () => infoModal.style.display = "none";
infoModal.onclick = e => { if(e.target === infoModal) infoModal.style.display="none"; };

// PeerJS
let peer = new Peer();
let conn = null;

peer.on('open', id => {
  myPeerIdEl.textContent = id;
  receiveStatus.textContent = "Peerç”Ÿæˆå®Œäº†ã€‚é€ä¿¡ã‚’å¾…æ©Ÿä¸­...";
});

// Receive connection
peer.on('connection', c => {
  conn = c;
  receiveStatus.textContent = "âœ… æ¥ç¶š: " + conn.peer;
  conn.on('data', data => {
    receivedData = data;
    receivedFileName.textContent = "backup_" + new Date().toISOString().slice(0,10) + ".dat";
    receivedFileArea.classList.remove("hidden");
    receiveStatus.textContent = "âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å—ä¿¡å®Œäº†";
  });
});

// Send backup
sendBackupBtn.onclick = () => {
  const targetId = targetPeerIdInput.value.trim();
  if(!targetId) return alert("å—ä¿¡å´PeerIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const backupData = JSON.stringify(localStorage);
  sendStatus.textContent = "â³ é€ä¿¡ä¸­...";
  sendStatus.className = "status wait";

  const connection = peer.connect(targetId);
  connection.on('open', () => {
    connection.send(backupData);
    sendStatus.textContent = "âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é€ä¿¡å®Œäº†";
    sendStatus.className = "status ok";
  });
  connection.on('error', err => {
    sendStatus.textContent = "âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼";
    sendStatus.className = "status err";
  });
};

// Load backup
loadBackupBtn.onclick = () => {
  if(!receivedData) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
  const json = JSON.parse(receivedData);
  for(const key in json) localStorage.setItem(key, json[key]);
  alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
  window.location.href = "home.html";
};

// Local file load
localFileInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const json = JSON.parse(reader.result);
    for(const key in json) localStorage.setItem(key, json[key]);
    alert("ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
    window.location.href = "home.html";
  };
  reader.readAsText(file);
});
</script>
</body>
</html>
