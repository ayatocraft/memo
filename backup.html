<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>バックアップオプション - メモアプリ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
<style>
body { font-family:"Segoe UI","Helvetica Neue",sans-serif; margin:0; padding:10px; background:#f3f3f3; }
.container { max-width:800px; margin:auto; }
h1 { text-align:center; color:#0078D4; }
.card { background:#fff; padding:20px; border-radius:6px; box-shadow:0 4px 8px rgba(0,0,0,0.1); margin-bottom:10px; }
button { background:#0078D4; color:#fff; border:none; padding:8px; border-radius:4px; cursor:pointer; }
button:hover { background:#005a9e; }
ul { list-style:none; padding:0; }
li { padding:6px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; }
input[type="file"] { margin-top:4px; }
.status { background:#eee; padding:8px; margin-top:10px; max-height:200px; overflow-y:auto; font-size:14px; }
.info { background:#e7f3fe; padding:10px; border-radius:4px; margin-bottom:10px; }
</style>
</head>
<body>
<div class="container">
    <h1>📦 メモ-バックアップオプション</h1>
    <div class="card info">
        このページでは近くの端末にバックアップを送信できます。<br>
        送信前に送信先端末のIDと位置情報を確認してください。
    </div>

    <div class="card">
        <h2>オンライン端末を選択して送信</h2>
        <ul id="deviceList"></ul>
        <button id="sendBtn">送信</button>
    </div>

    <div class="card">
        <h2>受信済みバックアップ</h2>
        <ul id="recvList"></ul>
        <input type="file" id="localFileInput">
        <button id="loadLocalBtn">ローカルから読み込み</button>
    </div>

    <div class="status" id="log"></div>
</div>

<script>
const ably = new Ably.Realtime('MwTA8A.xOgfaQ:hHOaQc-N5UpMmsueZflvvdfjHhHHDJi7x6plgKd5c-Y');
const channel = ably.channels.get('memo-backup');

let myId = 'device-' + Math.floor(Math.random()*10000);
let myPosition = {lat:null, lng:null};
let devices = {};
let recvQueue = [];

function log(msg){ 
    const box = document.getElementById('log'); 
    const div = document.createElement('div'); div.textContent = msg; box.appendChild(div); box.scrollTop = box.scrollHeight;
}

// 位置情報取得
navigator.geolocation.getCurrentPosition(pos => {
    myPosition.lat = pos.coords.latitude;
    myPosition.lng = pos.coords.longitude;
    registerDevice();
}, err => {
    log('⚠️ 位置情報取得できません: ' + err.message);
    registerDevice(); // 位置情報なくても登録
});

// 自分をAblyに登録
function registerDevice(){
    channel.presence.enter({id: myId, lat: myPosition.lat, lng: myPosition.lng});
}

// 端末リストを更新（10秒ごと）
function updateDeviceList(){
    channel.presence.get((err, members)=>{
        if(err) return log('❌ デバイス取得エラー: '+err);
        devices = {};
        const ul = document.getElementById('deviceList');
        ul.innerHTML = '';
        members.forEach(m=>{
            if(m.clientId === myId) return; // 自分は除く
            devices[m.clientId] = m.data;
            const li = document.createElement('li');
            li.innerHTML = `<label><input type="checkbox" value="${m.clientId}"> ${m.clientId} (lat:${m.data.lat}, lng:${m.data.lng})</label>`;
            ul.appendChild(li);
        });
        // 同一デバイス内のウィンドウをテスト用に追加
        const testId = myId + '-test';
        const li = document.createElement('li');
        li.innerHTML = `<label><input type="checkbox" value="${testId}"> ${testId} (テストウィンドウ)</label>`;
        ul.appendChild(li);
    });
}

updateDeviceList();
setInterval(updateDeviceList,10000);

// バックアップデータ作成
function createBackup(){
    const memoData = JSON.parse(localStorage.getItem('memos') || '[]');
    const blob = new Blob([JSON.stringify(memoData)], {type:'application/json'});
    return new File([blob], 'backup_' + Date.now() + '.dat', {type:'application/json'});
}

// 送信
document.getElementById('sendBtn').onclick = async ()=>{
    const checkboxes = document.querySelectorAll('#deviceList input[type=checkbox]:checked');
    if(!checkboxes.length) return alert('送信先を選択してください');
    const backupFile = createBackup();
    for(const cb of checkboxes){
        const targetId = cb.value;
        log(`📨 送信リクエスト: ${targetId}`);
        channel.publish('send-request', {
            fromId: myId,
            toId: targetId,
            filename: backupFile.name,
            fileData: await backupFile.arrayBuffer()
        });
    }
};

// 受信側イベント
channel.subscribe('send-request', async msg=>{
    if(msg.data.toId !== myId) return;
    const fromId = msg.data.fromId;
    const filename = msg.data.filename;
    const fileData = msg.data.fileData;
    const senderPos = msg.data.position || {lat:'不明', lng:'不明'};

    const approve = confirm(`バックアップ送信要求:\n送信元ID: ${fromId}\n位置: lat:${senderPos.lat}, lng:${senderPos.lng}\n受信しますか？`);
    channel.publish('send-response', {fromId: myId, toId: fromId, approved:approve});

    if(!approve) return log(`❌ ${fromId} からの送信拒否`);
    
    // 受信リストに追加
    const li = document.createElement('li');
    li.textContent = filename + ' ';
    const btn = document.createElement('button');
    btn.textContent = '読み込み';
    btn.onclick = ()=>{
        const blob = new Blob([fileData], {type:'application/json'});
        const reader = new FileReader();
        reader.onload = e=>{
            localStorage.setItem('memos', e.target.result);
            alert('バックアップを読み込みました');
        };
        reader.readAsText(blob);
    };
    li.appendChild(btn);
    document.getElementById('recvList').appendChild(li);
});

// 送信者への承認・拒否通知
channel.subscribe('send-response', msg=>{
    if(msg.data.toId !== myId) return;
    const status = msg.data.approved ? '承認されました' : '拒否されました';
    log(`📬 ${msg.data.fromId} への送信は${status}`);
});

// ローカルファイル読み込み
document.getElementById('loadLocalBtn').onclick = ()=>{
    const fileInput = document.getElementById('localFileInput');
    if(!fileInput.files.length) return alert('ファイルを選択してください');
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = e=>{
        localStorage.setItem('memos', e.target.result);
        alert('バックアップを読み込みました');
    };
    reader.readAsText(file);
};
</script>
</body>
</html>


