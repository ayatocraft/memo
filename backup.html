<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— - ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒª</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/ably/browser/static/ably.min.js"></script>
<style>
body {
    font-family: "Segoe UI", "Noto Sans JP", sans-serif;
    background: #f3f4f6;
    color: #333;
    margin: 0;
    padding: 0;
}
.backup-container {
    max-width: 600px;
    margin: 40px auto;
    background: #fff;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    position: relative;
}
h1 {
    text-align: center;
    margin-bottom: 10px;
}
.mode-select {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 20px 0;
}
button {
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    background: #0078d7;
    color: white;
    font-size: 15px;
    cursor: pointer;
    transition: 0.2s;
}
button:hover {
    background: #005fa3;
}
button.secondary {
    background: #ccc;
    color: #000;
}
.hidden { display: none; }
.section {
    background: #f9fafb;
    border-radius: 12px;
    padding: 20px;
    margin-top: 10px;
}
.status {
    margin-top: 8px;
    padding: 8px;
    border-radius: 8px;
    background: #eee;
    font-size: 14px;
}
.status.ok { background: #d1fae5; color: #065f46; }
.status.wait { background: #fef3c7; color: #92400e; }
.status.err { background: #fee2e2; color: #991b1b; }

.info-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: transparent;
    font-size: 22px;
    color: #666;
    cursor: pointer;
}

#infoModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    align-items: center;
    justify-content: center;
}
#infoContent {
    background: white;
    padding: 20px;
    border-radius: 12px;
    max-width: 500px;
    line-height: 1.6;
}
#infoContent h2 {
    margin-top: 0;
}
#infoContent button {
    background: #0078d7;
    color: white;
    float: right;
}
</style>
</head>
<body>
    <div class="backup-container">
        <button class="info-btn" id="infoBtn">â„¹ï¸</button>
        <h1>ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è»¢é€</h1>
        <p style="text-align:center;">åˆ¥ãƒ‡ãƒã‚¤ã‚¹ã¸ãƒ¡ãƒ¢ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è»¢é€ã—ã¾ã™ã€‚</p>

        <div class="mode-select">
            <button id="sendModeBtn">ğŸ“¤ é€ä¿¡ãƒ¢ãƒ¼ãƒ‰</button>
            <button id="receiveModeBtn">ğŸ“¥ å—ä¿¡ãƒ¢ãƒ¼ãƒ‰</button>
        </div>

        <div id="sendSection" class="section hidden">
            <h2>ğŸ“¤ é€ä¿¡ãƒ¢ãƒ¼ãƒ‰</h2>
            <p>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã€AblyçµŒç”±ã§é€ä¿¡ã—ã¾ã™ã€‚</p>
            <p><b>ãƒãƒ£ãƒ³ãƒãƒ«ID:</b> <span id="sendChannelId">-</span></p>
            <button id="generateBackup">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆï¼†é€ä¿¡é–‹å§‹</button>
            <div id="sendStatus" class="status"></div>
        </div>

        <div id="receiveSection" class="section hidden">
            <h2>ğŸ“¥ å—ä¿¡ãƒ¢ãƒ¼ãƒ‰</h2>
            <p>é€ä¿¡å´ã§è¡¨ç¤ºã•ã‚ŒãŸãƒãƒ£ãƒ³ãƒãƒ«IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <input type="text" id="channelInput" placeholder="ä¾‹: memo_backup_1234" style="width:100%;padding:8px;">
            <button id="connectChannel">æ¥ç¶š</button>
            <div id="receiveStatus" class="status"></div>

            <div id="receivedFileArea" class="hidden">
                <p>å—ä¿¡å®Œäº†: <b><span id="receivedFileName"></span></b></p>
                <button id="loadBackup">èª­ã¿è¾¼ã¿</button>
            </div>

            <hr>
            <p>ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼š</p>
            <input type="file" id="localFile">
        </div>

        <div style="text-align:center;margin-top:20px;">
            <button class="secondary" onclick="window.location.href='home.html'">ğŸ  ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal">
        <div id="infoContent">
            <h2>â„¹ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è»¢é€ã®ä½¿ã„æ–¹</h2>
            <ul>
                <li><b>é€ä¿¡ãƒ¢ãƒ¼ãƒ‰ï¼š</b> å¤ã„ç«¯æœ«ã§é–‹ãã€ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆï¼†é€ä¿¡é–‹å§‹ã€ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
                <li>è¡¨ç¤ºã•ã‚ŒãŸ <b>ãƒãƒ£ãƒ³ãƒãƒ«ID</b> ã‚’æ§ãˆã¦ãã ã•ã„ã€‚</li>
                <li><b>å—ä¿¡ãƒ¢ãƒ¼ãƒ‰ï¼š</b> æ–°ã—ã„ç«¯æœ«ã§é–‹ãã€æ§ãˆãŸIDã‚’å…¥åŠ› â†’ ã€Œæ¥ç¶šã€ã—ã¾ã™ã€‚</li>
                <li>å—ä¿¡å®Œäº†å¾Œã€ã€Œèª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒ¡ãƒ¢ãŒå¾©å…ƒã•ã‚Œã¾ã™ã€‚</li>
                <li>Wi-FiãŒç•°ãªã£ã¦ã„ã¦ã‚‚Ablyã‚µãƒ¼ãƒãƒ¼ã‚’ä»‹ã—ã¦é€šä¿¡ã§ãã¾ã™ã€‚</li>
                <li>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.datï¼‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ï¼èª­ã¿è¾¼ã¿ã‚‚å¯èƒ½ã§ã™ã€‚</li>
            </ul>
            <button id="closeInfo">é–‰ã˜ã‚‹</button>
        </div>
    </div>

<script>
const ably = new Ably.Realtime("m4nEkQ.t_3fkw:CyxgDJS1Z5J8b6FAiCxkO1F-t7cLQGIxmfin9BzL");

// è¦ç´ å–å¾—
const sendModeBtn = document.getElementById("sendModeBtn");
const receiveModeBtn = document.getElementById("receiveModeBtn");
const sendSection = document.getElementById("sendSection");
const receiveSection = document.getElementById("receiveSection");
const sendChannelIdEl = document.getElementById("sendChannelId");
const sendStatus = document.getElementById("sendStatus");
const receiveStatus = document.getElementById("receiveStatus");
const receivedFileArea = document.getElementById("receivedFileArea");
const receivedFileName = document.getElementById("receivedFileName");
const localFileInput = document.getElementById("localFile");
let receivedData = null;

// ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
sendModeBtn.onclick = () => {
    sendSection.classList.remove("hidden");
    receiveSection.classList.add("hidden");
};
receiveModeBtn.onclick = () => {
    receiveSection.classList.remove("hidden");
    sendSection.classList.add("hidden");
};

// Infoãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
const infoBtn = document.getElementById("infoBtn");
const infoModal = document.getElementById("infoModal");
const closeInfo = document.getElementById("closeInfo");
infoBtn.onclick = () => infoModal.style.display = "flex";
closeInfo.onclick = () => infoModal.style.display = "none";
infoModal.onclick = e => { if (e.target === infoModal) infoModal.style.display = "none"; };

// é€ä¿¡å‡¦ç†
document.getElementById("generateBackup").onclick = async () => {
    const channelId = "memo_backup_" + Math.floor(Math.random() * 10000);
    sendChannelIdEl.textContent = channelId;
    sendStatus.textContent = "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç”Ÿæˆä¸­...";
    sendStatus.className = "status wait";

    try {
        const data = JSON.stringify(localStorage);
        const fileName = "backup_" + new Date().toISOString().slice(0,10) + ".dat";
        const channel = ably.channels.get(channelId);
        await channel.publish("backup", { fileName, data });
        sendStatus.textContent = `âœ… é€ä¿¡å®Œäº†ã—ã¾ã—ãŸï¼ (${fileName})`;
        sendStatus.className = "status ok";
    } catch (e) {
        sendStatus.textContent = "âŒ é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ";
        sendStatus.className = "status err";
    }
};

// å—ä¿¡å‡¦ç†
document.getElementById("connectChannel").onclick = async () => {
    const id = document.getElementById("channelInput").value.trim();
    if (!id) return alert("ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    receiveStatus.textContent = "â³ æ¥ç¶šä¸­...";
    receiveStatus.className = "status wait";

    const channel = ably.channels.get(id);
    channel.subscribe("backup", (msg) => {
        receivedData = msg.data;
        receivedFileName.textContent = receivedData.fileName;
        receivedFileArea.classList.remove("hidden");
        receiveStatus.textContent = "âœ… å—ä¿¡å®Œäº†ã—ã¾ã—ãŸï¼";
        receiveStatus.className = "status ok";
    });
};

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿
document.getElementById("loadBackup").onclick = () => {
    if (!receivedData) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
    const json = JSON.parse(receivedData.data);
    for (const key in json) localStorage.setItem(key, json[key]);
    alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
    window.location.href = "home.html";
};

// ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
localFileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        const json = JSON.parse(reader.result);
        for (const key in json) localStorage.setItem(key, json[key]);
        alert("ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
        window.location.href = "home.html";
    };
    reader.readAsText(file);
});
</script>
</body>
</html>
