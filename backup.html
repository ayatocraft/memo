<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Memo Backup</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #f2f2f7;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  .container {
    width: 95%;
    max-width: 480px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 16px;
  }
  h1 {
    font-size: 1.3em;
    margin-bottom: 10px;
    text-align: center;
  }
  textarea {
    width: 100%;
    height: 150px;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 8px;
    resize: none;
  }
  button {
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    border: none;
    border-radius: 10px;
    background: #007aff;
    color: white;
    font-size: 1em;
    cursor: pointer;
  }
  button:hover {
    background: #005ecc;
  }
  .status {
    text-align: center;
    margin-top: 6px;
    font-size: 0.9em;
    color: #555;
  }
  .peer-info {
    text-align: center;
    margin-top: 8px;
    font-size: 0.8em;
    color: #666;
  }
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ“¦ Memo Backup</h1>
  <textarea id="memo" placeholder="ã“ã“ã«ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã¾ãŸã¯å—ä¿¡ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
  <button id="saveBtn">ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜</button>
  <button id="sendBtn">ğŸ“¤ é€ä¿¡</button>
  <button id="receiveBtn">ğŸ“¥ å—ä¿¡</button>
  <div class="status" id="status">çŠ¶æ…‹: æº–å‚™ä¸­...</div>
  <div class="peer-info" id="peerInfo"></div>
</div>

<!-- PeerJS / Ably -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ably/browser/static/ably.min.js"></script>
<script>
const statusEl = document.getElementById("status");
const peerInfo = document.getElementById("peerInfo");
const memoEl = document.getElementById("memo");

const ably = new Ably.Realtime("NQn9Eg.Bx1JEw:rrRNPzzOZAoe0wTDztCjCtsH_vwPxtOjPLZOiORKmTA");
const channel = ably.channels.get("memo-backup");

const peer = new Peer();
let myId = "";
let conn = null;

// PeeråˆæœŸåŒ–
peer.on("open", id => {
  myId = id;
  peerInfo.textContent = `ã‚ãªãŸã®PeerID: ${id}`;
  statusEl.textContent = "çŠ¶æ…‹: å¾…æ©Ÿä¸­";
  channel.publish("peer-status", { id, status: "online" });
});

// å—ä¿¡å´
peer.on("connection", c => {
  conn = c;
  statusEl.textContent = "çŠ¶æ…‹: æ¥ç¶šä¸­";
  c.on("data", data => {
    memoEl.value = data.memo;
    localStorage.setItem("memoData", data.memo);
    statusEl.textContent = "ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å—ä¿¡å®Œäº†";
    channel.publish("memo-received", { from: data.from });
  });
});

// ä¿å­˜
document.getElementById("saveBtn").onclick = () => {
  const text = memoEl.value.trim();
  if (!text) return alert("ãƒ¡ãƒ¢ãŒç©ºã§ã™");
  localStorage.setItem("memoData", text);
  alert("ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸ");
};

// é€ä¿¡
document.getElementById("sendBtn").onclick = async () => {
  const memo = localStorage.getItem("memoData");
  if (!memo || memo.trim() === "") {
    alert("é€ä¿¡ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆãªã—ï¼‰");
    return;
  }
  const target = prompt("é€ä¿¡å…ˆPeerIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
  if (!target) return;
  const c = peer.connect(target);
  c.on("open", () => {
    c.send({ from: myId, memo });
    alert("é€ä¿¡ã—ã¾ã—ãŸ âœ…");
    channel.publish("memo-sent", { from: myId, to: target });
  });
};

// å—ä¿¡ãƒ¢ãƒ¼ãƒ‰
document.getElementById("receiveBtn").onclick = () => {
  alert(`ã“ã®ç«¯æœ«ã®PeerIDã‚’ç›¸æ‰‹ã«æ•™ãˆã¦ãã ã•ã„ã€‚\nPeerID: ${myId}`);
  statusEl.textContent = "çŠ¶æ…‹: å—ä¿¡å¾…æ©Ÿä¸­...";
};

// Ablyé€šçŸ¥å—ä¿¡
channel.subscribe("memo-sent", msg => {
  console.log("é€ä¿¡é€šçŸ¥:", msg.data);
});
channel.subscribe("memo-received", msg => {
  console.log("å—ä¿¡é€šçŸ¥:", msg.data);
});
</script>
</body>
</html>
