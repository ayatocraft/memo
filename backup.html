<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— - Memo</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
<style>
body {
  font-family: "Segoe UI","Helvetica Neue",sans-serif;
  margin:0; padding:20px;
  background:#f3f3f3;
  display:flex; justify-content:center;
  min-height:100vh;
}
.card {
  background:#fff; border-radius:10px;
  padding:20px; max-width:720px; width:100%;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
h1 { text-align:center; color:#0078D4; }
.mode-select { display:flex; justify-content:center; gap:20px; margin:20px 0; }
button {
  padding:10px 16px;
  border:none;
  border-radius:5px;
  background:#0078D4;
  color:white;
  cursor:pointer;
  font-size:15px;
}
button:hover { background:#005a9e; }
.hidden { display:none; }
#status { background:#eee; padding:10px; margin-top:10px; max-height:200px; overflow-y:auto; font-size:14px; }
input[type=text], input[type=file] { width:100%; padding:8px; margin:6px 0; border-radius:3px; border:1px solid #ccc; }
progress { width:100%; height:16px; margin:4px 0; }
.file-link, .load-btn {
  display:inline-block; margin-top:6px;
  background:#107c10; color:white; text-decoration:none;
  padding:4px 8px; border-radius:4px; font-size:13px;
}
.load-btn { background:#0078D4; cursor:pointer; }
</style>
</head>
<body>
<div class="card">
  <h1>ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h1>
  <div class="mode-select">
    <button onclick="showMode('send')">ğŸ“¤ ä½œæˆï¼ˆé€ä¿¡ï¼‰</button>
    <button onclick="showMode('receive')">ğŸ“¥ èª­ã¿è¾¼ã¿ï¼ˆå—ä¿¡ï¼‰</button>
  </div>

  <!-- é€ä¿¡ãƒ¢ãƒ¼ãƒ‰ -->
  <div id="send-mode" class="mode hidden">
    <h2>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</h2>
    <p>ç¾åœ¨ã®ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.jsonã¾ãŸã¯.datï¼‰ã¨ã—ã¦ä¿å­˜ã—ã€Peeré€ä¿¡ã§ãã¾ã™ã€‚</p>
    <label>å½¢å¼é¸æŠï¼š
      <select id="formatSelect">
        <option value="json">JSON</option>
        <option value="dat">DAT</option>
      </select>
    </label>
    <button id="createBackupBtn">ğŸ“„ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ</button>
    <div id="backupResult"></div>
    <hr>
    <h3>Peerã§é€ä¿¡</h3>
    <div id="my-id"><span>ç”Ÿæˆä¸­...</span> <button id="copyId">ã‚³ãƒ”ãƒ¼</button></div>
    <input type="text" id="connect-id" placeholder="ç›¸æ‰‹ã®PeerIDã‚’å…¥åŠ›">
    <button id="sendBackupBtn">é€ä¿¡</button>
  </div>

  <!-- å—ä¿¡ãƒ¢ãƒ¼ãƒ‰ -->
  <div id="receive-mode" class="mode hidden">
    <h2>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿</h2>
    <p>ç›¸æ‰‹ãŒé€ä¿¡ã—ãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å—ä¿¡ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã€‚</p>
    <div id="my-id-recv"><span>ç”Ÿæˆä¸­...</span> <button id="copyRecvId">ã‚³ãƒ”ãƒ¼</button></div>
    <input type="file" id="localFileInput" accept=".json,.dat">
    <button id="loadLocalBtn">ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€</button>
    <div id="recvList"></div>
  </div>

  <div id="status"></div>
</div>

<script>
let peer, conn, latestBackupBlob=null, latestBackupName="";
let ably = new Ably.Realtime('MwTA8A.xOgfaQ:hHOaQc-N5UpMmsueZflvvdfjHhHHDJi7x6plgKd5c-Y');
let channel = ably.channels.get('memo-backup');

function appendLog(msg){
  const box=document.getElementById('status');
  const div=document.createElement('div');
  div.textContent=msg;
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

// ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
function showMode(mode){
  document.querySelectorAll('.mode').forEach(m=>m.classList.add('hidden'));
  document.getElementById(mode+'-mode').classList.remove('hidden');
  appendLog('ğŸ” ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿: '+(mode==='send'?'é€ä¿¡ãƒ¢ãƒ¼ãƒ‰':'å—ä¿¡ãƒ¢ãƒ¼ãƒ‰'));
  if(mode==='receive') initPeer('recv');
  if(mode==='send') initPeer('send');
}

// PeeråˆæœŸåŒ–
function initPeer(type){
  peer = new Peer({ config:{ iceServers:[{urls:"stun:stun.l.google.com:19302"}] } });
  peer.on('open', id=>{
    if(type==='send') document.querySelector('#my-id span').textContent=id;
    else document.querySelector('#my-id-recv span').textContent=id;
    appendLog('ğŸŸ¢ Peerèµ·å‹•: '+id);
    channel.publish('peer-ready', {id});
  });
  peer.on('connection', c=>{
    conn=c;
    setupConn(type);
  });
}

// ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³è¨­å®š
function setupConn(type){
  conn.on('open',()=>{
    appendLog('âœ… æ¥ç¶šæˆåŠŸ: '+conn.peer);
    if(type==='send') sendBackupData();
  });
  conn.on('data',data=>{
    if(data.type==='backup-file') receiveBackup(data);
  });
}

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
document.getElementById('createBackupBtn').onclick=()=>{
  const memos=JSON.parse(localStorage.getItem("memos")||"[]");
  const format=document.getElementById("formatSelect").value;
  const filename="memo_backup_"+new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')+"."+format;
  const content=format==="json"?JSON.stringify(memos,null,2):btoa(JSON.stringify(memos));
  const blob=new Blob([content],{type:"application/octet-stream"});
  latestBackupBlob=blob;
  latestBackupName=filename;

  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=filename;
  a.textContent='ğŸ“¥ '+filename+' ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
  a.className='file-link';
  const box=document.getElementById('backupResult');
  box.innerHTML='';
  box.appendChild(a);
  appendLog('ğŸ—‚ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº†: '+filename);
};

// IDã‚³ãƒ”ãƒ¼
document.getElementById('copyId').onclick=()=>{ navigator.clipboard.writeText(document.querySelector('#my-id span').textContent); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); };
document.getElementById('copyRecvId').onclick=()=>{ navigator.clipboard.writeText(document.querySelector('#my-id-recv span').textContent); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); };

// é€ä¿¡
document.getElementById('sendBackupBtn').onclick=()=>{
  const id=document.getElementById('connect-id').value.trim();
  if(!id) return alert('ç›¸æ‰‹ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if(!latestBackupBlob) return alert('å…ˆã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¦ãã ã•ã„');
  conn=peer.connect(id,{reliable:true});
  setupConn('send');
};

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é€ä¿¡
function sendBackupData(){
  latestBackupBlob.arrayBuffer().then(buf=>{
    conn.send({type:'backup-file', name:latestBackupName, data:buf});
    appendLog('ğŸ“¤ '+latestBackupName+' ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
  });
}

// å—ä¿¡å‡¦ç†
function receiveBackup(file){
  const blob=new Blob([file.data],{type:'application/octet-stream'});
  const url=URL.createObjectURL(blob);
  const div=document.createElement('div');
  div.textContent='ğŸ“¥ '+file.name+' ã‚’å—ä¿¡';
  const loadBtn=document.createElement('button');
  loadBtn.textContent='èª­ã¿è¾¼ã‚€';
  loadBtn.className='load-btn';
  loadBtn.onclick=()=>loadBackupFromBlob(blob);
  div.appendChild(loadBtn);
  document.getElementById('recvList').appendChild(div);
  appendLog('ğŸ“© ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å—ä¿¡å®Œäº†: '+file.name);
}

// ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
document.getElementById('loadLocalBtn').onclick=()=>{
  const file=document.getElementById('localFileInput').files[0];
  if(!file) return alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
  loadBackupFromFile(file);
};

function loadBackupFromFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    loadBackupContent(e.target.result);
  };
  reader.readAsText(file);
}

function loadBackupFromBlob(blob){
  const reader=new FileReader();
  reader.onload=e=>loadBackupContent(e.target.result);
  reader.readAsText(blob);
}

function loadBackupContent(content){
  try{
    let memos;
    if(content.trim().startsWith("[")) memos=JSON.parse(content);
    else memos=JSON.parse(atob(content));
    localStorage.setItem("memos",JSON.stringify(memos));
    appendLog('âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
    alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ãƒ›ãƒ¼ãƒ ã«æˆ»ã£ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }catch(e){
    alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: "+e.message);
  }
}
</script>
</body>
</html>
