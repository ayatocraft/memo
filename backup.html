<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— - ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
<style>
body { font-family: "Segoe UI","Helvetica Neue",sans-serif; margin:0; padding:0; background:#f3f3f3; }
.container { max-width:720px; margin:20px auto; background:#fff; border-radius:6px; padding:20px; box-shadow:0 4px 8px rgba(0,0,0,0.1);}
h1 { color:#0078D4; text-align:center; }
button { padding:8px 12px; border:none; border-radius:4px; background:#0078D4; color:#fff; cursor:pointer; margin:4px 0; }
button:hover { background:#005a9e; }
#deviceList { list-style:none; padding:0; margin:0; }
#deviceList li { padding:6px 4px; border-bottom:1px solid #ccc; display:flex; justify-content:space-between; align-items:center; }
.status { margin-top:10px; padding:8px; background:#eee; max-height:200px; overflow-y:auto; font-size:14px; }
.info { margin-bottom:10px; background:#d9edf7; padding:10px; border-radius:4px; font-size:14px; }
</style>
</head>
<body>
<div class="container">
    <h1>ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h1>
    <div class="info">
        è¿‘ãã®ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œå‡ºã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’é€ä¿¡ã§ãã¾ã™ã€‚<br>
        å—ä¿¡æ™‚ã¯é€ä¿¡å…ƒã®IDã¨ä½ç½®æƒ…å ±ã‚’ç¢ºèªã—ã¦æ‰¿èªã—ã¦ãã ã•ã„ã€‚<br>
        å®Œå…¨å‰Šé™¤ã¯ localStorage ã®å…¨ãƒ¡ãƒ¢ã‚’æ¶ˆå»ã—ã¾ã™ã€‚
    </div>
    <ul id="deviceList"></ul>
    <button id="refreshBtn">ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆæ›´æ–°</button>
    <button id="clearLocalStorageBtn">ğŸ“ ãƒ¡ãƒ¢ã‚’å®Œå…¨å‰Šé™¤</button>
    <div class="status" id="statusBox"></div>
</div>

<script>
const ably = new Ably.Realtime('MwTA8A.xOgfaQ:hHOaQc-N5UpMmsueZflvvdfjHhHHDJi7x6plgKd5c-Y');
const channel = ably.channels.get('memo-backup');
let devices = [];
let myId = 'device-' + Math.random().toString(36).slice(2,10);
const statusBox = document.getElementById('statusBox');
let memoData = []; // backup.htmlèµ·å‹•æ™‚ã«ä¸€åº¦ã ã‘èª­ã¿è¾¼ã¿ã€ãã‚Œä»¥é™ã¯æ›´æ–°ã—ãªã„

// èµ·å‹•æ™‚ã«ä¸€åº¦ã ã‘ memo ã‚’å–å¾—
try {
    memoData = JSON.parse(localStorage.getItem('memos')||'[]');
} catch(e){
    memoData = [];
    console.warn('æ—¢å­˜ãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
}

function log(msg){
    const div = document.createElement('div');
    div.textContent = msg;
    statusBox.appendChild(div);
    statusBox.scrollTop = statusBox.scrollHeight;
}

// ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’ãƒªã‚¹ãƒˆæ›´æ–°
function updateDeviceList(){
    const ul = document.getElementById('deviceList');
    ul.innerHTML = '';
    devices.forEach(d=>{
        const li = document.createElement('li');
        li.textContent = `${d.id} (${d.location||'ä½ç½®æƒ…å ±ãªã—'})`;
        const chk = document.createElement('input');
        chk.type='checkbox';
        chk.dataset.id = d.id;
        li.appendChild(chk);
        ul.appendChild(li);
    });
}

// 10ç§’ã”ã¨ã«è‡ªåˆ†ä»¥å¤–ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’åé›†
setInterval(()=>{
    channel.publish('announce', {id: myId});
}, 10000);

channel.subscribe('announce', msg=>{
    if(msg.data.id !== myId){
        const exists = devices.find(d=>d.id===msg.data.id);
        if(!exists){
            devices.push({id: msg.data.id, location: msg.data.location||'ä¸æ˜'});
            log(`æ¤œå‡º: ${msg.data.id}`);
            updateDeviceList();
        }
    }
});

// æ‰‹å‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
document.getElementById('refreshBtn').onclick = ()=>{ devices=[]; log('ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ'); };

// é€ä¿¡å‡¦ç†
function sendBackup(toId){
    const dataStr = JSON.stringify(memoData);
    channel.publish('backup-send', {to: toId, from: myId, data: dataStr});
    log(`é€ä¿¡: ${toId}`);
}

// å—ä¿¡å‡¦ç†
channel.subscribe('backup-send', msg=>{
    if(msg.data.to !== myId) return; // è‡ªåˆ†å®›ã§ãªã„å ´åˆã¯ç„¡è¦–

    const confirmMsg = `ãƒ‡ãƒã‚¤ã‚¹ ${msg.data.from} ã‹ã‚‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å—ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`;
    if(confirm(confirmMsg)){
        try{
            const parsed = JSON.parse(msg.data.data);
            localStorage.setItem('memos', JSON.stringify(parsed));
            log(`å—ä¿¡å®Œäº†: ${msg.data.from}`);
        } catch(e){
            log(`å—ä¿¡å¤±æ•—: ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£`);
        }
    } else {
        log(`å—ä¿¡æ‹’å¦: ${msg.data.from}`);
    }
});

// å®Œå…¨å‰Šé™¤ãƒœã‚¿ãƒ³
document.getElementById('clearLocalStorageBtn').onclick = ()=>{
    if(confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')){
        localStorage.removeItem('memos');
        memoData=[];
        log('å…¨ã¦ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }
};

// ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é¸æŠé€ä¿¡ãƒœã‚¿ãƒ³ã‚’è‡ªå‹•ä½œæˆ
const sendBtn = document.createElement('button');
sendBtn.textContent = 'âœ… é¸æŠã—ãŸãƒ‡ãƒã‚¤ã‚¹ã«é€ä¿¡';
sendBtn.onclick = ()=>{
    const checked = Array.from(document.querySelectorAll('#deviceList input[type=checkbox]:checked'));
    if(!checked.length) return alert('é€ä¿¡å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„');
    checked.forEach(c=> sendBackup(c.dataset.id));
};
document.body.appendChild(sendBtn);

</script>
</body>
</html>
