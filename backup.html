<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>バックアップ - メモアプリ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
<style>
body { font-family:"Segoe UI","Helvetica Neue",sans-serif; margin:0; padding:10px; background:#f3f3f3; }
.container { max-width:900px; margin:auto; }
h1 { text-align:center; color:#0078D4; margin-bottom:20px; }
.card { background:#fff; padding:15px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:15px; }
.card-header { font-weight:bold; margin-bottom:10px; color:#0078D4; display:flex; justify-content:space-between; align-items:center; }
.device-card { border:1px solid #ddd; border-radius:6px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
.device-info { display:flex; flex-direction:column; }
button { background:#0078D4; color:#fff; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; font-size:14px; }
button:hover { background:#005a9e; }
input[type="checkbox"] { transform:scale(1.2); margin-right:8px; }
.status { background:#eee; padding:8px; margin-top:10px; max-height:200px; overflow-y:auto; font-size:14px; border-radius:6px; }
.info { background:#e7f3fe; padding:10px; border-radius:6px; margin-bottom:10px; }
@media(max-width:600px){ .device-card{ flex-direction:column; align-items:flex-start; } }
</style>
</head>
<body>
<div class="container">
    <h1>📦 メモバックアップ</h1>

    <div class="card info">
        このページでは近くの端末にバックアップを送信できます。<br>
        送信前に送信先端末のIDと位置情報を確認してください。
    </div>

    <div class="card">
        <div class="card-header">オンライン端末</div>
        <div id="deviceList"></div>
        <button id="sendBtn">選択した端末に送信</button>
    </div>

    <div class="card">
        <div class="card-header">受信済みバックアップ</div>
        <div id="recvList"></div>
        <input type="file" id="localFileInput">
        <button id="loadLocalBtn">ローカルから読み込み</button>
    </div>

    <div class="status" id="log"></div>
</div>

<script>
const ably = new Ably.Realtime('MwTA8A.xOgfaQ:hHOaQc-N5UpMmsueZflvvdfjHhHHDJi7x6plgKd5c-Y');
const channel = ably.channels.get('memo-backup');

let myId = 'device-' + Math.floor(Math.random()*10000);
let myPosition = {lat:null, lng:null};
let devices = {};

// ログ表示
function log(msg){ const box = document.getElementById('log'); const div = document.createElement('div'); div.textContent = msg; box.appendChild(div); box.scrollTop = box.scrollHeight; }

// 位置情報取得
navigator.geolocation.getCurrentPosition(pos => { myPosition.lat=pos.coords.latitude; myPosition.lng=pos.coords.longitude; registerDevice(); },
    err => { log('⚠️ 位置情報取得できません: ' + err.message); registerDevice(); });

// 自分をAblyに登録
function registerDevice(){ channel.presence.enter({id: myId, lat: myPosition.lat, lng: myPosition.lng}); }

// 端末リスト更新
function updateDeviceList(){
    channel.presence.get((err, members)=>{
        if(err) return log('❌ デバイス取得エラー: '+err);
        devices={};
        const container = document.getElementById('deviceList');
        container.innerHTML='';
        members.forEach(m=>{
            if(m.clientId===myId) return;
            devices[m.clientId]=m.data;
            const div = document.createElement('div'); div.className='device-card';
            div.innerHTML=`<div class="device-info">
                <label><input type="checkbox" value="${m.clientId}">${m.clientId}</label>
                <span>位置: lat:${m.data.lat}, lng:${m.data.lng}</span>
            </div>`;
            container.appendChild(div);
        });
        // 同一デバイス内ウィンドウ（テスト用）
        const testId = myId+'-test';
        const div = document.createElement('div'); div.className='device-card';
        div.innerHTML=`<div class="device-info">
            <label><input type="checkbox" value="${testId}">${testId} (テストウィンドウ)</label>
        </div>`;
        container.appendChild(div);
    });
}
updateDeviceList();
setInterval(updateDeviceList,10000);

// ArrayBuffer ↔ Base64
function arrayBufferToBase64(buffer){
    let binary=''; const bytes=new Uint8Array(buffer);
    const len=bytes.byteLength;
    for(let i=0;i<len;i++){ binary+=String.fromCharCode(bytes[i]); }
    return btoa(binary);
}
function base64ToArrayBuffer(base64){
    const binary = atob(base64);
    const len = binary.length;
    const bytes = new Uint8Array(len);
    for(let i=0;i<len;i++) bytes[i]=binary.charCodeAt(i);
    return bytes.buffer;
}

// バックアップ作成
function createBackup(){
    const memoData = JSON.parse(localStorage.getItem('memos') || '[]');
    const blob = new Blob([JSON.stringify(memoData)], {type:'application/json'});
    return new File([blob],'backup_'+Date.now()+'.dat',{type:'application/json'});
}

// 送信
document.getElementById('sendBtn').onclick = async ()=>{
    const checkboxes = document.querySelectorAll('#deviceList input[type=checkbox]:checked');
    if(!checkboxes.length) return alert('送信先を選択してください');
    const backupFile = createBackup();
    const buffer = await backupFile.arrayBuffer();
    const b64data = arrayBufferToBase64(buffer);

    for(const cb of checkboxes){
        const targetId = cb.value;
        log(`📨 送信リクエスト: ${targetId}`);
        channel.publish('send-request',{
            fromId: myId,
            toId: targetId,
            filename: backupFile.name,
            fileData: b64data,
            position: myPosition
        });
    }
};

// 受信側
channel.subscribe('send-request', async msg=>{
    if(msg.data.toId !== myId) return;
    const fromId = msg.data.fromId;
    const filename = msg.data.filename;
    const fileData = base64ToArrayBuffer(msg.data.fileData);
    const senderPos = msg.data.position || {lat:'不明', lng:'不明'};

    const approve = confirm(`バックアップ送信要求:\n送信元ID: ${fromId}\n位置: lat:${senderPos.lat}, lng:${senderPos.lng}\n受信しますか？`);
    channel.publish('send-response',{fromId: myId, toId: fromId, approved:approve});

    if(!approve) return log(`❌ ${fromId} からの送信拒否`);

    const div = document.createElement('div'); div.className='device-card';
    div.innerHTML = `<span>${filename}</span>`;
    const btn = document.createElement('button'); btn.textContent='読み込み';
    btn.onclick=()=>{
        const blob=new Blob([fileData],{type:'application/json'});
        const reader=new FileReader();
        reader.onload=e=>{ localStorage.setItem('memos', e.target.result); alert('バックアップを読み込みました'); };
        reader.readAsText(blob);
    };
    div.appendChild(btn);
    document.getElementById('recvList').appendChild(div);
});

// 送信者への承認/拒否通知
channel.subscribe('send-response', msg=>{
    if(msg.data.toId!==myId) return;
    const status = msg.data.approved ? '承認されました' : '拒否されました';
    log(`📬 ${msg.data.fromId} への送信は${status}`);
});

// ローカル読み込み
document.getElementById('loadLocalBtn').onclick=()=>{
    const fileInput=document.getElementById('localFileInput');
    if(!fileInput.files.length) return alert('ファイルを選択してください');
    const file=fileInput.files[0];
    const reader=new FileReader();
    reader.onload=e=>{ localStorage.setItem('memos', e.target.result); alert('バックアップを読み込みました'); };
    reader.readAsText(file);
};
</script>
</body>
</html>
