<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>バックアップ - メモアプリ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
<style>
body { font-family: "Segoe UI","Helvetica Neue",sans-serif; margin:0; padding:0; background:#f3f3f3; }
.container { max-width:720px; margin:20px auto; background:#fff; border-radius:6px; padding:20px; box-shadow:0 4px 8px rgba(0,0,0,0.1);}
h1 { color:#0078D4; text-align:center; }
button { padding:8px 12px; border:none; border-radius:4px; background:#0078D4; color:#fff; cursor:pointer; margin:4px 0; }
button:hover { background:#005a9e; }
#deviceList { list-style:none; padding:0; margin:0; }
#deviceList li { padding:6px 4px; border-bottom:1px solid #ccc; display:flex; justify-content:space-between; align-items:center; }
.status { margin-top:10px; padding:8px; background:#eee; max-height:200px; overflow-y:auto; font-size:14px; }
.info { margin-bottom:10px; background:#d9edf7; padding:10px; border-radius:4px; font-size:14px; }
</style>
</head>
<body>
<div class="container">
    <h1>💾 バックアップ</h1>
    <div class="info">
        近くのデバイスを検出してバックアップを送信できます。<br>
        受信時は送信元のIDと位置情報を確認して承認してください。<br>
        完全削除は localStorage の全メモを消去します。
    </div>
    <ul id="deviceList"></ul>
    <button id="refreshBtn">デバイスリスト更新</button>
    <button id="clearLocalStorageBtn">📁 メモを完全削除</button>
    <div class="status" id="statusBox"></div>
</div>

<script>
const ably = new Ably.Realtime('MwTA8A.xOgfaQ:hHOaQc-N5UpMmsueZflvvdfjHhHHDJi7x6plgKd5c-Y');
const channel = ably.channels.get('memo-backup');
let devices = [];
let myId = 'device-' + Math.random().toString(36).slice(2,10);
const statusBox = document.getElementById('statusBox');
let memoData = []; // backup.html起動時に一度だけ読み込み、それ以降は更新しない

// 起動時に一度だけ memo を取得
try {
    memoData = JSON.parse(localStorage.getItem('memos')||'[]');
} catch(e){
    memoData = [];
    console.warn('既存メモの読み込みに失敗しました');
}

function log(msg){
    const div = document.createElement('div');
    div.textContent = msg;
    statusBox.appendChild(div);
    statusBox.scrollTop = statusBox.scrollHeight;
}

// デバイス情報をリスト更新
function updateDeviceList(){
    const ul = document.getElementById('deviceList');
    ul.innerHTML = '';
    devices.forEach(d=>{
        const li = document.createElement('li');
        li.textContent = `${d.id} (${d.location||'位置情報なし'})`;
        const chk = document.createElement('input');
        chk.type='checkbox';
        chk.dataset.id = d.id;
        li.appendChild(chk);
        ul.appendChild(li);
    });
}

// 10秒ごとに自分以外のデバイスを収集
setInterval(()=>{
    channel.publish('announce', {id: myId});
}, 10000);

channel.subscribe('announce', msg=>{
    if(msg.data.id !== myId){
        const exists = devices.find(d=>d.id===msg.data.id);
        if(!exists){
            devices.push({id: msg.data.id, location: msg.data.location||'不明'});
            log(`検出: ${msg.data.id}`);
            updateDeviceList();
        }
    }
});

// 手動リフレッシュ
document.getElementById('refreshBtn').onclick = ()=>{ devices=[]; log('リストをクリアしました'); };

// 送信処理
function sendBackup(toId){
    const dataStr = JSON.stringify(memoData);
    channel.publish('backup-send', {to: toId, from: myId, data: dataStr});
    log(`送信: ${toId}`);
}

// 受信処理
channel.subscribe('backup-send', msg=>{
    if(msg.data.to !== myId) return; // 自分宛でない場合は無視

    const confirmMsg = `デバイス ${msg.data.from} からバックアップを受信しますか？`;
    if(confirm(confirmMsg)){
        try{
            const parsed = JSON.parse(msg.data.data);
            localStorage.setItem('memos', JSON.stringify(parsed));
            log(`受信完了: ${msg.data.from}`);
        } catch(e){
            log(`受信失敗: データ形式が不正`);
        }
    } else {
        log(`受信拒否: ${msg.data.from}`);
    }
});

// 完全削除ボタン
document.getElementById('clearLocalStorageBtn').onclick = ()=>{
    if(confirm('本当に全てのメモを削除しますか？ この操作は元に戻せません。')){
        localStorage.removeItem('memos');
        memoData=[];
        log('全てのメモを削除しました');
    }
};

// チェックボックス選択送信ボタンを自動作成
const sendBtn = document.createElement('button');
sendBtn.textContent = '✅ 選択したデバイスに送信';
sendBtn.onclick = ()=>{
    const checked = Array.from(document.querySelectorAll('#deviceList input[type=checkbox]:checked'));
    if(!checked.length) return alert('送信先を選択してください');
    checked.forEach(c=> sendBackup(c.dataset.id));
};
document.body.appendChild(sendBtn);

</script>
</body>
</html>
