<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>バックアップ転送 - メモアプリ</title>
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
<style>
body { font-family: "Segoe UI","Noto Sans JP",sans-serif; margin:0; padding:20px; background:#f3f4f6; color:#333;}
.container { max-width:700px; margin:0 auto; background:white; padding:20px 30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
h1 { text-align:center; margin-top:0; }
.mode-section { display:flex; gap:10px; justify-content:center; margin-bottom:20px; flex-wrap:wrap; }
.mode-section button { flex:1 1 45%; min-width:140px; padding:12px; font-size:16px; cursor:pointer; border:none; border-radius:8px; background:#0078D7; color:white; }
.mode-section button:hover { background:#005fa3; }
.section { display:none; margin-top:20px; padding:20px; border-radius:10px; background:#f9fafb; border:1px solid #e5e7eb; }
.section h2 { margin-top:0; text-align:center; }
.status { margin-top:20px; padding:10px; border-radius:6px; background:#eee; text-align:center; word-wrap: break-word; }
input[type="text"], input[type="file"] { width:100%; padding:8px 10px; margin-top:6px; border-radius:6px; border:1px solid #ccc; font-size:14px; box-sizing:border-box; margin-bottom:15px; }
button.action-btn { width:100%; padding:10px; font-size:16px; cursor:pointer; border:none; border-radius:8px; color:white; margin-top:10px; }
#sendBackupBtn { background:#0078D7; } #sendBackupBtn:hover { background:#005fa3; }
#downloadBackupBtn { background:#28a745; } #downloadBackupBtn:hover { background:#218838; }
#restoreBackupBtn { background:#17a2b8; } #restoreBackupBtn:hover { background:#138496; }
#clearDataBtn { background:#dc3545; } #clearDataBtn:hover { background:#a71d2a; }
#homeBtn { background:#6c757d; } #homeBtn:hover { background:#495057; }
</style>
</head>
<body>
<div class="container">
<h1>バックアップ転送</h1>

<div class="mode-section">
<button id="sendModeBtn">送信モード</button>
<button id="receiveModeBtn">受信モード</button>
</div>

<div id="sendMode" class="section">
<h2>送信モード</h2>
<p>受信側コードを入力してください。</p>
<input type="text" id="receiverCode" placeholder="受信側コード">
<button id="sendBackupBtn" class="action-btn">送信</button>
<hr>
<p style="text-align:center;">またはバックアップをローカルにダウンロード</p>
<button id="downloadBackupBtn" class="action-btn">ダウンロード</button>
</div>

<div id="receiveMode" class="section">
<h2>受信モード</h2>
<p>自分の受信コードを設定してください。送信側に伝えます。</p>
<input type="text" id="myCode" placeholder="自分用コード">
<button id="restoreBackupBtn" class="action-btn">受信開始 / 復元</button>
</div>

<hr>
<button id="clearDataBtn" class="action-btn">初期化</button>
<button id="homeBtn" class="action-btn">ホームへ戻る</button>
<div id="status" class="status">モードを選択してください</div>
</div>

<script>
window.onload=()=>{
const sendModeBtn=document.getElementById('sendModeBtn');
const receiveModeBtn=document.getElementById('receiveModeBtn');
const sendMode=document.getElementById('sendMode');
const receiveMode=document.getElementById('receiveMode');
const status=document.getElementById('status');

const receiverCode=document.getElementById('receiverCode');
const sendBackupBtn=document.getElementById('sendBackupBtn');
const downloadBackupBtn=document.getElementById('downloadBackupBtn');

const myCodeInput=document.getElementById('myCode');
const restoreBackupBtn=document.getElementById('restoreBackupBtn');

const clearDataBtn=document.getElementById('clearDataBtn');
const homeBtn=document.getElementById('homeBtn');

// --- Ably ---
const ably=new Ably.Realtime('NQn9Eg.Bx1JEw:rrRNPzzOZAoe0wTDztCjCtsH_vwPxtOjPLZOiORKmTA');
const channels={};

// --- モード切替 ---
sendModeBtn.onclick=()=>{
sendMode.style.display='block';
receiveMode.style.display='none';
status.textContent='送信モード。受信側コードを入力してください。';
};
receiveModeBtn.onclick=()=>{
sendMode.style.display='none';
receiveMode.style.display='block';
status.textContent='受信モード。コードを入力して開始してください。';
};

// --- 送信 ---
sendBackupBtn.onclick=()=>{
const code=receiverCode.value.trim();
if(!code){ alert('受信側コードを入力'); return; }
const allData={};
for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); allData[k]=localStorage.getItem(k);}
if(Object.keys(allData).length===0){ alert('送信データなし'); return; }

let ch=ably.channels.get('memo-backup-'+code);
ch.publish('backup', allData, (err)=>{
if(err){ status.textContent='送信失敗'; console.error(err);}
else{ status.textContent='送信完了'; alert('データ送信完了'); }
});
};

// --- ダウンロード ---
downloadBackupBtn.onclick=()=>{
const allData={};
for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); allData[k]=localStorage.getItem(k);}
if(Object.keys(allData).length===0){ alert('バックアップデータなし'); return; }
const blob=new Blob([JSON.stringify(allData,null,2)], {type:'application/dat'});
const a=document.createElement('a');
a.href=URL.createObjectURL(blob);
a.download='memo_backup.dat';
document.body.appendChild(a); a.click(); document.body.removeChild(a);
status.textContent='バックアップをダウンロードしました';
};

// --- 受信 ---
restoreBackupBtn.onclick=()=>{
const code=myCodeInput.value.trim();
if(!code){ alert('自分用コードを入力'); return; }
if(channels[code]) return; // すでに購読中
const ch=ably.channels.get('memo-backup-'+code);
channels[code]=ch;
ch.subscribe('backup',(msg)=>{
try{
const data=msg.data;
if(confirm('データを復元してもよいですか？（上書きされます）')){
localStorage.clear();
for(const k in data){ localStorage.setItem(k,data[k]); }
alert('データ復元完了');
status.textContent='データ復元完了';
}
}catch(e){ alert('復元エラー: '+e.message); status.textContent='復元エラー'; console.error(e);}
});
status.textContent='受信待機中...';
alert('受信準備完了。送信側にコードを伝えてください。');
};

// --- 初期化 ---
clearDataBtn.onclick=()=>{ if(confirm('全データ削除しますか？')){ localStorage.clear(); alert('初期化完了'); status.textContent='初期化完了'; } };

// --- ホーム ---
homeBtn.onclick=()=>{ location.href='home.html'; };

};
</script>
</body>
</html>
