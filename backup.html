<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Memo Backup</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #f2f2f7;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  .container {
    width: 95%;
    max-width: 480px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 16px;
  }
  h1 {
    font-size: 1.3em;
    margin-bottom: 10px;
    text-align: center;
  }
  textarea {
    width: 100%;
    height: 150px;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 8px;
    resize: none;
  }
  button {
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    border: none;
    border-radius: 10px;
    background: #007aff;
    color: white;
    font-size: 1em;
    cursor: pointer;
  }
  button:hover {
    background: #005ecc;
  }
  .status {
    text-align: center;
    margin-top: 6px;
    font-size: 0.9em;
    color: #555;
  }
  .peer-info {
    text-align: center;
    margin-top: 8px;
    font-size: 0.8em;
    color: #666;
  }
</style>
</head>
<body>
<div class="container">
  <h1>📦 Memo Backup</h1>
  <textarea id="memo" placeholder="ここにメモを入力または受信データが表示されます"></textarea>
  <button id="saveBtn">💾 ローカル保存</button>
  <button id="sendBtn">📤 送信</button>
  <button id="receiveBtn">📥 受信</button>
  <div class="status" id="status">状態: 準備中...</div>
  <div class="peer-info" id="peerInfo"></div>
</div>

<!-- PeerJS / Ably -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ably/browser/static/ably.min.js"></script>
<script>
const statusEl = document.getElementById("status");
const peerInfo = document.getElementById("peerInfo");
const memoEl = document.getElementById("memo");

const ably = new Ably.Realtime("NQn9Eg.Bx1JEw:rrRNPzzOZAoe0wTDztCjCtsH_vwPxtOjPLZOiORKmTA");
const channel = ably.channels.get("memo-backup");

const peer = new Peer();
let myId = "";
let conn = null;

// Peer初期化
peer.on("open", id => {
  myId = id;
  peerInfo.textContent = `あなたのPeerID: ${id}`;
  statusEl.textContent = "状態: 待機中";
  channel.publish("peer-status", { id, status: "online" });
});

// 受信側
peer.on("connection", c => {
  conn = c;
  statusEl.textContent = "状態: 接続中";
  c.on("data", data => {
    memoEl.value = data.memo;
    localStorage.setItem("memoData", data.memo);
    statusEl.textContent = "📥 データ受信完了";
    channel.publish("memo-received", { from: data.from });
  });
});

// 保存
document.getElementById("saveBtn").onclick = () => {
  const text = memoEl.value.trim();
  if (!text) return alert("メモが空です");
  localStorage.setItem("memoData", text);
  alert("ローカルに保存しました");
};

// 送信
document.getElementById("sendBtn").onclick = async () => {
  const memo = localStorage.getItem("memoData");
  if (!memo || memo.trim() === "") {
    alert("送信できるデータがありません（なし）");
    return;
  }
  const target = prompt("送信先PeerIDを入力してください:");
  if (!target) return;
  const c = peer.connect(target);
  c.on("open", () => {
    c.send({ from: myId, memo });
    alert("送信しました ✅");
    channel.publish("memo-sent", { from: myId, to: target });
  });
};

// 受信モード
document.getElementById("receiveBtn").onclick = () => {
  alert(`この端末のPeerIDを相手に教えてください。\nPeerID: ${myId}`);
  statusEl.textContent = "状態: 受信待機中...";
};

// Ably通知受信
channel.subscribe("memo-sent", msg => {
  console.log("送信通知:", msg.data);
});
channel.subscribe("memo-received", msg => {
  console.log("受信通知:", msg.data);
});
</script>
</body>
</html>
