<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— - ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
<style>
body { font-family:"Segoe UI","Helvetica Neue",sans-serif; margin:0; padding:10px; background:#f3f3f3; }
.container { max-width:900px; margin:auto; }
h1 { text-align:center; color:#0078D4; margin-bottom:20px; }
.card { background:#fff; padding:15px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:15px; }
.card-header { font-weight:bold; margin-bottom:10px; color:#0078D4; display:flex; justify-content:space-between; align-items:center; }
.device-card { border:1px solid #ddd; border-radius:6px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
.device-info { display:flex; flex-direction:column; }
button { background:#0078D4; color:#fff; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; font-size:14px; }
button:hover { background:#005a9e; }
input[type="checkbox"] { transform:scale(1.2); margin-right:8px; }
.status { background:#eee; padding:8px; margin-top:10px; max-height:200px; overflow-y:auto; font-size:14px; border-radius:6px; }
.info { background:#e7f3fe; padding:10px; border-radius:6px; margin-bottom:10px; }
@media(max-width:600px){ .device-card{ flex-direction:column; align-items:flex-start; } }
</style>
</head>
<body>
<div class="container">
    <h1>ğŸ“¦ ãƒ¡ãƒ¢ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h1>

    <div class="card info">
        ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯è¿‘ãã®ç«¯æœ«ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’é€ä¿¡ã§ãã¾ã™ã€‚<br>
        é€ä¿¡å‰ã«é€ä¿¡å…ˆç«¯æœ«ã®IDã¨ä½ç½®æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="card">
        <div class="card-header">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç«¯æœ«</div>
        <div id="deviceList"></div>
        <button id="sendBtn">é¸æŠã—ãŸç«¯æœ«ã«é€ä¿¡</button>
    </div>

    <div class="card">
        <div class="card-header">å—ä¿¡æ¸ˆã¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
        <div id="recvList"></div>
        <input type="file" id="localFileInput">
        <button id="loadLocalBtn">ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</button>
    </div>

    <div class="status" id="log"></div>
</div>

<script>
const ably = new Ably.Realtime('MwTA8A.xOgfaQ:hHOaQc-N5UpMmsueZflvvdfjHhHHDJi7x6plgKd5c-Y');
const channel = ably.channels.get('memo-backup');

let myId = 'device-' + Math.floor(Math.random()*10000);
let myPosition = {lat:null, lng:null};
let devices = {};

// ãƒ­ã‚°è¡¨ç¤º
function log(msg){ const box = document.getElementById('log'); const div = document.createElement('div'); div.textContent = msg; box.appendChild(div); box.scrollTop = box.scrollHeight; }

// ä½ç½®æƒ…å ±å–å¾—
navigator.geolocation.getCurrentPosition(pos => { myPosition.lat=pos.coords.latitude; myPosition.lng=pos.coords.longitude; registerDevice(); },
    err => { log('âš ï¸ ä½ç½®æƒ…å ±å–å¾—ã§ãã¾ã›ã‚“: ' + err.message); registerDevice(); });

// è‡ªåˆ†ã‚’Ablyã«ç™»éŒ²
function registerDevice(){ channel.presence.enter({id: myId, lat: myPosition.lat, lng: myPosition.lng}); }

// ç«¯æœ«ãƒªã‚¹ãƒˆæ›´æ–°
function updateDeviceList(){
    channel.presence.get((err, members)=>{
        if(err) return log('âŒ ãƒ‡ãƒã‚¤ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼: '+err);
        devices={};
        const container = document.getElementById('deviceList');
        container.innerHTML='';
        members.forEach(m=>{
            if(m.clientId===myId) return;
            devices[m.clientId]=m.data;
            const div = document.createElement('div'); div.className='device-card';
            div.innerHTML=`<div class="device-info">
                <label><input type="checkbox" value="${m.clientId}">${m.clientId}</label>
                <span>ä½ç½®: lat:${m.data.lat}, lng:${m.data.lng}</span>
            </div>`;
            container.appendChild(div);
        });
        // åŒä¸€ãƒ‡ãƒã‚¤ã‚¹å†…ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
        const testId = myId+'-test';
        const div = document.createElement('div'); div.className='device-card';
        div.innerHTML=`<div class="device-info">
            <label><input type="checkbox" value="${testId}">${testId} (ãƒ†ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦)</label>
        </div>`;
        container.appendChild(div);
    });
}
updateDeviceList();
setInterval(updateDeviceList,10000);

// ArrayBuffer â†” Base64
function arrayBufferToBase64(buffer){
    let binary=''; const bytes=new Uint8Array(buffer);
    const len=bytes.byteLength;
    for(let i=0;i<len;i++){ binary+=String.fromCharCode(bytes[i]); }
    return btoa(binary);
}
function base64ToArrayBuffer(base64){
    const binary = atob(base64);
    const len = binary.length;
    const bytes = new Uint8Array(len);
    for(let i=0;i<len;i++) bytes[i]=binary.charCodeAt(i);
    return bytes.buffer;
}

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
function createBackup(){
    const memoData = JSON.parse(localStorage.getItem('memos') || '[]');
    const blob = new Blob([JSON.stringify(memoData)], {type:'application/json'});
    return new File([blob],'backup_'+Date.now()+'.dat',{type:'application/json'});
}

// é€ä¿¡
document.getElementById('sendBtn').onclick = async ()=>{
    const checkboxes = document.querySelectorAll('#deviceList input[type=checkbox]:checked');
    if(!checkboxes.length) return alert('é€ä¿¡å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„');
    const backupFile = createBackup();
    const buffer = await backupFile.arrayBuffer();
    const b64data = arrayBufferToBase64(buffer);

    for(const cb of checkboxes){
        const targetId = cb.value;
        log(`ğŸ“¨ é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ${targetId}`);
        channel.publish('send-request',{
            fromId: myId,
            toId: targetId,
            filename: backupFile.name,
            fileData: b64data,
            position: myPosition
        });
    }
};

// å—ä¿¡å´
channel.subscribe('send-request', async msg=>{
    if(msg.data.toId !== myId) return;
    const fromId = msg.data.fromId;
    const filename = msg.data.filename;
    const fileData = base64ToArrayBuffer(msg.data.fileData);
    const senderPos = msg.data.position || {lat:'ä¸æ˜', lng:'ä¸æ˜'};

    const approve = confirm(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é€ä¿¡è¦æ±‚:\né€ä¿¡å…ƒID: ${fromId}\nä½ç½®: lat:${senderPos.lat}, lng:${senderPos.lng}\nå—ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`);
    channel.publish('send-response',{fromId: myId, toId: fromId, approved:approve});

    if(!approve) return log(`âŒ ${fromId} ã‹ã‚‰ã®é€ä¿¡æ‹’å¦`);

    const div = document.createElement('div'); div.className='device-card';
    div.innerHTML = `<span>${filename}</span>`;
    const btn = document.createElement('button'); btn.textContent='èª­ã¿è¾¼ã¿';
    btn.onclick=()=>{
        const blob=new Blob([fileData],{type:'application/json'});
        const reader=new FileReader();
        reader.onload=e=>{ localStorage.setItem('memos', e.target.result); alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ'); };
        reader.readAsText(blob);
    };
    div.appendChild(btn);
    document.getElementById('recvList').appendChild(div);
});

// é€ä¿¡è€…ã¸ã®æ‰¿èª/æ‹’å¦é€šçŸ¥
channel.subscribe('send-response', msg=>{
    if(msg.data.toId!==myId) return;
    const status = msg.data.approved ? 'æ‰¿èªã•ã‚Œã¾ã—ãŸ' : 'æ‹’å¦ã•ã‚Œã¾ã—ãŸ';
    log(`ğŸ“¬ ${msg.data.fromId} ã¸ã®é€ä¿¡ã¯${status}`);
});

// ãƒ­ãƒ¼ã‚«ãƒ«èª­ã¿è¾¼ã¿
document.getElementById('loadLocalBtn').onclick=()=>{
    const fileInput=document.getElementById('localFileInput');
    if(!fileInput.files.length) return alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
    const file=fileInput.files[0];
    const reader=new FileReader();
    reader.onload=e=>{ localStorage.setItem('memos', e.target.result); alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ'); };
    reader.readAsText(file);
};
</script>
</body>
</html>
