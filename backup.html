<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>バックアップ転送 - メモアプリ</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
body {
    font-family: "Segoe UI", "Noto Sans JP", sans-serif;
    margin:0; padding:20px;
    background:#f3f4f6;
    color: #333;
}
.container {
    max-width:700px;
    margin:0 auto;
    background:white;
    padding:20px 30px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
h1 { 
    text-align:center; 
    color: #111;
    margin-top: 0;
}
.mode-section { 
    display:flex; 
    gap:10px; 
    justify-content:center; 
    margin-bottom:20px; 
    flex-wrap:wrap; 
}
.mode-section button { 
    flex:1 1 45%; 
    min-width:140px; 
    padding:12px; 
    font-size:16px; 
    font-weight: 500;
    cursor:pointer; 
    border:none; 
    border-radius:8px; 
    background:#0078D7; 
    color:white; 
    transition: background-color 0.2s;
}
.mode-section button:hover { background:#005fa3; }

.section { 
    display:none; 
    margin-top:20px; 
    padding:20px; 
    border-radius:10px; 
    background:#f9fafb;
    border: 1px solid #e5e7eb;
}
.section h2 {
    margin-top: 0;
    text-align: center;
    color: #333;
}

.status { 
    margin-top:20px; 
    padding:10px 15px; 
    border-radius:6px; 
    background:#eee; 
    font-size:14px; 
    text-align: center;
    word-wrap: break-word;
}
#myPeerIdContainer { 
    display:flex; 
    gap:10px; 
    align-items:center; 
    margin-bottom:15px; 
    flex-wrap:wrap; 
    justify-content: center;
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
}
#myPeerId { 
    font-weight:bold; 
    font-size: 1.1em;
    color: #005fa3;
    word-break: break-all;
}
button.copyBtn { 
    background:#4CAF50; 
    color:white; 
    padding:6px 10px; 
    font-size:14px; 
    border-radius:4px; 
    border:none; 
    cursor:pointer; 
}
button.copyBtn:hover { background:#357a38; }

input[type="text"] { 
    width: 100%; 
    padding: 8px 10px; 
    margin-top: 6px; 
    border-radius: 6px; 
    border: 1px solid #ccc; 
    font-size: 14px; 
    box-sizing: border-box; /* 幅計算のため */
    margin-bottom: 15px;
}
/* 接続ボタンとアクションボタンのスタイル */
#connectBtn, .action-btn {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    border-radius: 8px;
    color: white;
    margin-top: 10px;
    transition: background-color 0.2s;
}

#connectBtn {
    background: #0078D7;
}
#connectBtn:hover {
    background: #005fa3;
}

/* 追加したボタンのスタイル */
#downloadBackupBtn {
    background: #28a745; /* 緑系 */
}
#downloadBackupBtn:hover {
    background: #218838;
}
#loadFromFileBtn {
    background: #17a2b8; /* 青緑系 */
}
#loadFromFileBtn:hover {
    background: #138496;
}

</style>
</head>
<body>

<div class="container">
    <h1>バックアップ転送</h1>

    <div class="mode-section">
        <button id="sendModeBtn">送信モード</button>
        <button id="receiveModeBtn">受信モード</button>
    </div>

    <!-- 送信モード -->
    <div id="sendMode" class="section">
        <h2>送信モード</h2>
        <p>1. 受信側で「受信モード」を選択し、表示された「自分のID」をコピーしてもらいます。</p>
        <p>2. 下の入力欄に、受信側のIDを貼り付けて「接続」ボタンを押してください。</p>
        
        <!-- P2P転送（相手のID入力） -->
        <input type="text" id="remotePeerId" placeholder="受信側のIDを入力">
        <button id="connectBtn">接続して送信</button>

        <hr style="border: 0; border-top: 1px solid #ddd; margin: 25px 0;">

        <!-- ローカルダウンロード（追加機能） -->
        <p style="text-align:center; margin-bottom: 10px;">または、バックアップファイルをローカルに保存します。</p>
        <button id="downloadBackupBtn" class="action-btn">バックアップをローカルにダウンロード</button>
    </div>

    <!-- 受信モード -->
    <div id="receiveMode" class="section">
        <h2>受信モード</h2>
        <p>1. 下に表示される「自分のID」をコピーして、送信側に伝えてください。</p>
        <p>2. 送信側が接続すると、自動的にデータが受信されます。</p>

        <!-- P2P転送（自分のID表示） -->
        <div id="myPeerIdContainer">
            ID: <span id="myPeerId">取得中...</span>
            <button class="copyBtn" id="copyBtn">コピー</button>
        </div>

        <hr style="border: 0; border-top: 1px solid #ddd; margin: 25px 0;">

        <!-- ローカルから読み込み（追加機能） -->
        <p style="text-align:center; margin-bottom: 10px;">または、ローカルのバックアップファイルから復元します。</p>
        <input type="file" id="backupFileInput" accept=".json" style="display:none;">
        <button id="loadFromFileBtn" class="action-btn">ローカルファイルから読み込み</button>
    </div>

    <div id="status" class="status">モードを選択してください</div>
</div>

<script>
window.onload = () => {
    const sendModeBtn = document.getElementById('sendModeBtn');
    const receiveModeBtn = document.getElementById('receiveModeBtn');
    const sendMode = document.getElementById('sendMode');
    const receiveMode = document.getElementById('receiveMode');
    const myPeerId = document.getElementById('myPeerId');
    const copyBtn = document.getElementById('copyBtn');
    const remotePeerId = document.getElementById('remotePeerId');
    const connectBtn = document.getElementById('connectBtn');
    const status = document.getElementById('status');

    // --- 追加した要素 ---
    const downloadBackupBtn = document.getElementById('downloadBackupBtn');
    const loadFromFileBtn = document.getElementById('loadFromFileBtn');
    const backupFileInput = document.getElementById('backupFileInput');

    let peer = null;
    let peerIdTimer = null; // (修正) タイムアウト監視用

    // モード切り替え
    sendModeBtn.onclick = () => {
        sendMode.style.display = 'block';
        receiveMode.style.display = 'none';
        status.textContent = '送信モード。受信側のIDを入力してください。';
        initializePeer(); // 送信側もP2P使うのでPeer初期化
    };

    receiveModeBtn.onclick = () => {
        sendMode.style.display = 'none';
        receiveMode.style.display = 'block';
        status.textContent = '受信モード。Peer IDを取得中です...';
        myPeerId.textContent = '取得中...'; // (追加) モード切替時にリセット
        initializePeer();
    };

    // PeerJSの初期化
    function initializePeer() {
        if (peer) {
            peer.destroy(); // 既存の接続を破棄
        }
        if (peerIdTimer) {
            clearTimeout(peerIdTimer); // (修正) 既存のタイマーをクリア
        }

        // (修正) 10秒以内にIDが取得できない場合のエラー処理
        peerIdTimer = setTimeout(() => {
            if (receiveMode.style.display === 'block' && myPeerId.textContent === '取得中...') {
                const errorMsg = 'P2Pサーバーへの接続がタイムアウトしました。ネットワークを確認するか、時間をおいて再試行してください。';
                status.textContent = errorMsg;
                myPeerId.textContent = '取得失敗';
                console.warn(errorMsg);
            }
        }, 10000); // 10秒

        peer = new Peer(); // PeerJSサーバーはデフォルトを使用

        peer.on('open', id => {
            clearTimeout(peerIdTimer); // (修正) タイムアウトをクリア
            if (receiveMode.style.display === 'block') {
                myPeerId.textContent = id;
                status.textContent = '受信待機中。上記のIDを送信側に伝えてください。';
            }
        });

        // データ受信時の処理 (P2P)
        peer.on('connection', conn => {
            status.textContent = '接続されました。データ受信中...';
            conn.on('data', data => {
                try {
                    restoreFromBackup(data);
                    status.textContent = 'データ受信完了。正常に復元されました。';
                    alert('バックアップから復元しました。');
                } catch (e) {
                    status.textContent = `エラー: データの復元に失敗しました。 ${e.message}`;
                    console.error(e);
                    alert('データの形式が正しくないため、復元に失敗しました。');
                }
            });
        });

        // (修正) エラーハンドリングを詳細化
        peer.on('error', err => {
            clearTimeout(peerIdTimer); // エラー時もタイマーをクリア
            
            let errorMessage = `P2Pエラー: ${err.type}`;
            console.error('PeerJS error:', err);
            
            if (err.type === 'peer-unavailable') {
                errorMessage = '指定されたIDが見つかりません。';
                alert(errorMessage);
            } else if (err.type === 'network') {
                errorMessage = 'ネットワーク接続に問題があるか、P2Pサーバーに接続できません。';
                alert(errorMessage);
            } else if (err.type === 'server-error' || err.type === 'socket-error' || err.type === 'browser-incompatible') {
                errorMessage = 'P2Pサーバーとの接続に失敗しました。ブラウザが非対応か、時間をおいて再試行してください。';
                alert(errorMessage);
            } else if (err.type === 'disconnected') {
                 errorMessage = 'P2Pサーバーから切断されました。';
            } else {
                 alert(`不明なP2Pエラーが発生しました: ${err.type}`);
            }
            
            status.textContent = errorMessage;
            
            // 受信モードでID取得に失敗した場合
            if (receiveMode.style.display === 'block') {
                myPeerId.textContent = '取得失敗';
            }
        });
    }

    // 接続ボタン (データ送信)
    connectBtn.onclick = () => {
        if (!peer || peer.destroyed) { // (修正) peerが破棄されていないかもチェック
            status.textContent = 'Peerが初期化されていません。モードを再度選択してください。';
            return;
        }
        const remoteId = remotePeerId.value;
        if (!remoteId) {
            alert('受信側のIDを入力してください。');
            return;
        }

        status.textContent = '接続中...';
        const conn = peer.connect(remoteId);

        conn.on('open', () => {
            status.textContent = '接続完了。データを送信中...';
            try {
                // (修正) 全プロファイルのデータをバックアップする
                const allData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    // 'memoapp_' で始まるキー（プロファイルデータや設定）を対象
                    if (key.startsWith('memoapp_')) {
                        allData[key] = localStorage.getItem(key);
                    }
                }

                if (Object.keys(allData).length === 0) {
                     alert('送信するデータがありません。');
                     status.textContent = '送信データがありませんでした。';
                     conn.close();
                     return;
                }

                conn.send(allData); // 全データを送信
                status.textContent = 'データ送信完了。';
            } catch (e) {
                status.textContent = `エラー: データの取得または送信に失敗しました。 ${e.message}`;
                console.error(e);
            }
        });

        conn.on('error', err => {
            status.textContent = `接続エラー: ${err.type}`;
            console.error('Connection error:', err);
        });
    };

    // IDコピーボタン
    copyBtn.onclick = () => {
        if (myPeerId.textContent === '取得中...' || myPeerId.textContent === '取得失敗') {
            alert('IDがまだ取得できていません。');
            return;
        }
        navigator.clipboard.writeText(myPeerId.textContent).then(() => {
            alert('IDをクリップボードにコピーしました。');
        }).catch(err => {
            alert('コピーに失敗しました。');
            console.error('Copy failed:', err);
        });
    };

    // --- バックアップデータの復元（共通関数） ---
    // (修正) 複数のプロファイルデータ(allData)を復元できるように変更
    function restoreFromBackup(data) {
        if (typeof data !== 'object' || data === null) {
            throw new Error('無効なデータ形式です (Not an object)');
        }

        // (重要) 現在のデータを消去する前に確認する
        let keysToClear = [];
        for (let i = 0; i < localStorage.length; i++) {
            if (localStorage.key(i).startsWith('memoapp_')) {
                keysToClear.push(localStorage.key(i));
            }
        }
        
        if (keysToClear.length > 0) {
            if (!window.confirm('現在のすべてのプロファイルとメモデータを、バックアップファイルの内容で上書きします。よろしいですか？')) {
                throw new Error('復元がキャンセルされました。');
            }
        }

        // 現在の 'memoapp_' データをすべて消去
        keysToClear.forEach(key => {
            localStorage.removeItem(key);
        });

        // バックアップデータから復元
        let restoredCount = 0;
        for (const key in data) {
            // 'memoapp_' で始まるキーのみを復元
            if (key.startsWith('memoapp_') && typeof data[key] === 'string') {
                localStorage.setItem(key, data[key]);
                restoredCount++;
            }
        }
        
        if (restoredCount === 0) {
            throw new Error('バックアップデータに有効なメモデータが含まれていませんでした。');
        }
    }


    // --- (追加機能) バックアップをダウンロード ---
    downloadBackupBtn.onclick = () => {
        try {
            // (修正) 全プロファイルのデータをバックアップする
            const allData = {};
            let hasData = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('memoapp_')) {
                    allData[key] = localStorage.getItem(key);
                    hasData = true;
                }
            }
            
            if (!hasData) {
                alert('バックアップするデータがありません。');
                return;
            }

            const jsonString = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            
            // 日付からファイル名を生成
            const date = new Date();
            const Y = date.getFullYear();
            const M = (date.getMonth() + 1).toString().padStart(2, '0');
            const D = date.getDate().toString().padStart(2, '0');
            const h = date.getHours().toString().padStart(2, '0');
            const m = date.getMinutes().toString().padStart(2, '0');
            
            a.download = `memo_backup_all_${Y}${M}${D}_${h}${m}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            
            status.textContent = 'バックアップファイルをダウンロードしました。';

        } catch (e) {
            status.textContent = `ダウンロードエラー: ${e.message}`;
            console.error(e);
            alert('バックアップファイルの作成に失敗しました。');
        }
    };

    // --- (追加機能) ローカルファイルから読み込み ---
    
    // 読み込みボタンがクリックされたら、非表示のファイル入力をクリックする
    loadFromFileBtn.onclick = () => {
        backupFileInput.click();
    };

    // ファイルが選択された時の処理
    backupFileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const data = JSON.parse(text);
                
                // 復元処理
                restoreFromBackup(data);
                
                status.textContent = `ファイル (${file.name}) からデータを復元しました。`;
                alert('バックアップファイルからデータを復元しました。\n(ホーム画面に戻ると反映されます)');

            } catch (err) {
                status.textContent = `ファイル読み込みエラー: ${err.message}`;
                console.error(err);
                alert(`ファイルの形式が正しくないか、読み込みに失敗しました。\n${err.message}`);
            } finally {
                // 同じファイルを連続で選択できるように値をリセット
                event.target.value = null;
            }
        };

        reader.onerror = () => {
            status.textContent = 'ファイルの読み込みに失敗しました。';
            alert('ファイルの読み込みに失敗しました。');
            event.target.value = null;
        };

        reader.readAsText(file);
    };
};
</script>

</body>
</html>

