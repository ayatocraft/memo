<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚ªãƒ—ã‚·ãƒ§ãƒ³ - ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
<style>
body { font-family:"Segoe UI","Helvetica Neue",sans-serif; margin:0; padding:10px; background:#f3f3f3; }
.container { max-width:800px; margin:auto; }
h1 { text-align:center; color:#0078D4; }
.card { background:#fff; padding:20px; border-radius:6px; box-shadow:0 4px 8px rgba(0,0,0,0.1); margin-bottom:10px; }
button { background:#0078D4; color:#fff; border:none; padding:8px; border-radius:4px; cursor:pointer; }
button:hover { background:#005a9e; }
ul { list-style:none; padding:0; }
li { padding:6px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; }
input[type="file"] { margin-top:4px; }
.status { background:#eee; padding:8px; margin-top:10px; max-height:200px; overflow-y:auto; font-size:14px; }
.info { background:#e7f3fe; padding:10px; border-radius:4px; margin-bottom:10px; }
</style>
</head>
<body>
<div class="container">
    <h1>ğŸ“¦ ãƒ¡ãƒ¢-ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h1>
    <div class="card info">
        ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯è¿‘ãã®ç«¯æœ«ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’é€ä¿¡ã§ãã¾ã™ã€‚<br>
        é€ä¿¡å‰ã«é€ä¿¡å…ˆç«¯æœ«ã®IDã¨ä½ç½®æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="card">
        <h2>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç«¯æœ«ã‚’é¸æŠã—ã¦é€ä¿¡</h2>
        <ul id="deviceList"></ul>
        <button id="sendBtn">é€ä¿¡</button>
    </div>

    <div class="card">
        <h2>å—ä¿¡æ¸ˆã¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
        <ul id="recvList"></ul>
        <input type="file" id="localFileInput">
        <button id="loadLocalBtn">ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</button>
    </div>

    <div class="status" id="log"></div>
</div>

<script>
const ably = new Ably.Realtime('MwTA8A.xOgfaQ:hHOaQc-N5UpMmsueZflvvdfjHhHHDJi7x6plgKd5c-Y');
const channel = ably.channels.get('memo-backup');

let myId = 'device-' + Math.floor(Math.random()*10000);
let myPosition = {lat:null, lng:null};
let devices = {};
let recvQueue = [];

function log(msg){ 
    const box = document.getElementById('log'); 
    const div = document.createElement('div'); div.textContent = msg; box.appendChild(div); box.scrollTop = box.scrollHeight;
}

// ä½ç½®æƒ…å ±å–å¾—
navigator.geolocation.getCurrentPosition(pos => {
    myPosition.lat = pos.coords.latitude;
    myPosition.lng = pos.coords.longitude;
    registerDevice();
}, err => {
    log('âš ï¸ ä½ç½®æƒ…å ±å–å¾—ã§ãã¾ã›ã‚“: ' + err.message);
    registerDevice(); // ä½ç½®æƒ…å ±ãªãã¦ã‚‚ç™»éŒ²
});

// è‡ªåˆ†ã‚’Ablyã«ç™»éŒ²
function registerDevice(){
    channel.presence.enter({id: myId, lat: myPosition.lat, lng: myPosition.lng});
}

// ç«¯æœ«ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆ10ç§’ã”ã¨ï¼‰
function updateDeviceList(){
    channel.presence.get((err, members)=>{
        if(err) return log('âŒ ãƒ‡ãƒã‚¤ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼: '+err);
        devices = {};
        const ul = document.getElementById('deviceList');
        ul.innerHTML = '';
        members.forEach(m=>{
            if(m.clientId === myId) return; // è‡ªåˆ†ã¯é™¤ã
            devices[m.clientId] = m.data;
            const li = document.createElement('li');
            li.innerHTML = `<label><input type="checkbox" value="${m.clientId}"> ${m.clientId} (lat:${m.data.lat}, lng:${m.data.lng})</label>`;
            ul.appendChild(li);
        });
        // åŒä¸€ãƒ‡ãƒã‚¤ã‚¹å†…ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ãƒ†ã‚¹ãƒˆç”¨ã«è¿½åŠ 
        const testId = myId + '-test';
        const li = document.createElement('li');
        li.innerHTML = `<label><input type="checkbox" value="${testId}"> ${testId} (ãƒ†ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦)</label>`;
        ul.appendChild(li);
    });
}

updateDeviceList();
setInterval(updateDeviceList,10000);

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ä½œæˆ
function createBackup(){
    const memoData = JSON.parse(localStorage.getItem('memos') || '[]');
    const blob = new Blob([JSON.stringify(memoData)], {type:'application/json'});
    return new File([blob], 'backup_' + Date.now() + '.dat', {type:'application/json'});
}

// é€ä¿¡
document.getElementById('sendBtn').onclick = async ()=>{
    const checkboxes = document.querySelectorAll('#deviceList input[type=checkbox]:checked');
    if(!checkboxes.length) return alert('é€ä¿¡å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„');
    const backupFile = createBackup();
    for(const cb of checkboxes){
        const targetId = cb.value;
        log(`ğŸ“¨ é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ${targetId}`);
        channel.publish('send-request', {
            fromId: myId,
            toId: targetId,
            filename: backupFile.name,
            fileData: await backupFile.arrayBuffer()
        });
    }
};

// å—ä¿¡å´ã‚¤ãƒ™ãƒ³ãƒˆ
channel.subscribe('send-request', async msg=>{
    if(msg.data.toId !== myId) return;
    const fromId = msg.data.fromId;
    const filename = msg.data.filename;
    const fileData = msg.data.fileData;
    const senderPos = msg.data.position || {lat:'ä¸æ˜', lng:'ä¸æ˜'};

    const approve = confirm(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é€ä¿¡è¦æ±‚:\né€ä¿¡å…ƒID: ${fromId}\nä½ç½®: lat:${senderPos.lat}, lng:${senderPos.lng}\nå—ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`);
    channel.publish('send-response', {fromId: myId, toId: fromId, approved:approve});

    if(!approve) return log(`âŒ ${fromId} ã‹ã‚‰ã®é€ä¿¡æ‹’å¦`);
    
    // å—ä¿¡ãƒªã‚¹ãƒˆã«è¿½åŠ 
    const li = document.createElement('li');
    li.textContent = filename + ' ';
    const btn = document.createElement('button');
    btn.textContent = 'èª­ã¿è¾¼ã¿';
    btn.onclick = ()=>{
        const blob = new Blob([fileData], {type:'application/json'});
        const reader = new FileReader();
        reader.onload = e=>{
            localStorage.setItem('memos', e.target.result);
            alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        };
        reader.readAsText(blob);
    };
    li.appendChild(btn);
    document.getElementById('recvList').appendChild(li);
});

// é€ä¿¡è€…ã¸ã®æ‰¿èªãƒ»æ‹’å¦é€šçŸ¥
channel.subscribe('send-response', msg=>{
    if(msg.data.toId !== myId) return;
    const status = msg.data.approved ? 'æ‰¿èªã•ã‚Œã¾ã—ãŸ' : 'æ‹’å¦ã•ã‚Œã¾ã—ãŸ';
    log(`ğŸ“¬ ${msg.data.fromId} ã¸ã®é€ä¿¡ã¯${status}`);
});

// ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
document.getElementById('loadLocalBtn').onclick = ()=>{
    const fileInput = document.getElementById('localFileInput');
    if(!fileInput.files.length) return alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = e=>{
        localStorage.setItem('memos', e.target.result);
        alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
    };
    reader.readAsText(file);
};
</script>
</body>
</html>


