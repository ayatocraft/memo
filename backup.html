<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>バックアップ - Memo</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
<style>
body {
  font-family: "Segoe UI","Helvetica Neue",sans-serif;
  margin:0; padding:20px;
  background:#f3f3f3;
  display:flex; justify-content:center;
  min-height:100vh;
}
.card {
  background:#fff; border-radius:10px;
  padding:20px; max-width:720px; width:100%;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
h1 { text-align:center; color:#0078D4; }
.mode-select { display:flex; justify-content:center; gap:20px; margin:20px 0; }
button {
  padding:10px 16px;
  border:none;
  border-radius:5px;
  background:#0078D4;
  color:white;
  cursor:pointer;
  font-size:15px;
}
button:hover { background:#005a9e; }
.hidden { display:none; }
#status { background:#eee; padding:10px; margin-top:10px; max-height:200px; overflow-y:auto; font-size:14px; }
input[type=text], input[type=file] { width:100%; padding:8px; margin:6px 0; border-radius:3px; border:1px solid #ccc; }
progress { width:100%; height:16px; margin:4px 0; }
.file-link, .load-btn {
  display:inline-block; margin-top:6px;
  background:#107c10; color:white; text-decoration:none;
  padding:4px 8px; border-radius:4px; font-size:13px;
}
.load-btn { background:#0078D4; cursor:pointer; }
</style>
</head>
<body>
<div class="card">
  <h1>💾 バックアップ</h1>
  <div class="mode-select">
    <button onclick="showMode('send')">📤 作成（送信）</button>
    <button onclick="showMode('receive')">📥 読み込み（受信）</button>
  </div>

  <!-- 送信モード -->
  <div id="send-mode" class="mode hidden">
    <h2>バックアップ作成</h2>
    <p>現在のメモデータをバックアップファイル（.jsonまたは.dat）として保存し、Peer送信できます。</p>
    <label>形式選択：
      <select id="formatSelect">
        <option value="json">JSON</option>
        <option value="dat">DAT</option>
      </select>
    </label>
    <button id="createBackupBtn">📄 バックアップを作成</button>
    <div id="backupResult"></div>
    <hr>
    <h3>Peerで送信</h3>
    <div id="my-id"><span>生成中...</span> <button id="copyId">コピー</button></div>
    <input type="text" id="connect-id" placeholder="相手のPeerIDを入力">
    <button id="sendBackupBtn">送信</button>
  </div>

  <!-- 受信モード -->
  <div id="receive-mode" class="mode hidden">
    <h2>バックアップ読み込み</h2>
    <p>相手が送信したバックアップを受信するか、ファイルを選択して読み込みます。</p>
    <div id="my-id-recv"><span>生成中...</span> <button id="copyRecvId">コピー</button></div>
    <input type="file" id="localFileInput" accept=".json,.dat">
    <button id="loadLocalBtn">📂 ファイルから読み込む</button>
    <div id="recvList"></div>
  </div>

  <div id="status"></div>
</div>

<script>
let peer, conn, latestBackupBlob=null, latestBackupName="";
let ably = new Ably.Realtime('MwTA8A.xOgfaQ:hHOaQc-N5UpMmsueZflvvdfjHhHHDJi7x6plgKd5c-Y');
let channel = ably.channels.get('memo-backup');

function appendLog(msg){
  const box=document.getElementById('status');
  const div=document.createElement('div');
  div.textContent=msg;
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

// モード切替
function showMode(mode){
  document.querySelectorAll('.mode').forEach(m=>m.classList.add('hidden'));
  document.getElementById(mode+'-mode').classList.remove('hidden');
  appendLog('🔁 モード切替: '+(mode==='send'?'送信モード':'受信モード'));
  if(mode==='receive') initPeer('recv');
  if(mode==='send') initPeer('send');
}

// Peer初期化
function initPeer(type){
  peer = new Peer({ config:{ iceServers:[{urls:"stun:stun.l.google.com:19302"}] } });
  peer.on('open', id=>{
    if(type==='send') document.querySelector('#my-id span').textContent=id;
    else document.querySelector('#my-id-recv span').textContent=id;
    appendLog('🟢 Peer起動: '+id);
    channel.publish('peer-ready', {id});
  });
  peer.on('connection', c=>{
    conn=c;
    setupConn(type);
  });
}

// コネクション設定
function setupConn(type){
  conn.on('open',()=>{
    appendLog('✅ 接続成功: '+conn.peer);
    if(type==='send') sendBackupData();
  });
  conn.on('data',data=>{
    if(data.type==='backup-file') receiveBackup(data);
  });
}

// バックアップ作成
document.getElementById('createBackupBtn').onclick=()=>{
  const memos=JSON.parse(localStorage.getItem("memos")||"[]");
  const format=document.getElementById("formatSelect").value;
  const filename="memo_backup_"+new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')+"."+format;
  const content=format==="json"?JSON.stringify(memos,null,2):btoa(JSON.stringify(memos));
  const blob=new Blob([content],{type:"application/octet-stream"});
  latestBackupBlob=blob;
  latestBackupName=filename;

  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=filename;
  a.textContent='📥 '+filename+' をダウンロード';
  a.className='file-link';
  const box=document.getElementById('backupResult');
  box.innerHTML='';
  box.appendChild(a);
  appendLog('🗂️ バックアップ作成完了: '+filename);
};

// IDコピー
document.getElementById('copyId').onclick=()=>{ navigator.clipboard.writeText(document.querySelector('#my-id span').textContent); alert('コピーしました'); };
document.getElementById('copyRecvId').onclick=()=>{ navigator.clipboard.writeText(document.querySelector('#my-id-recv span').textContent); alert('コピーしました'); };

// 送信
document.getElementById('sendBackupBtn').onclick=()=>{
  const id=document.getElementById('connect-id').value.trim();
  if(!id) return alert('相手のIDを入力してください');
  if(!latestBackupBlob) return alert('先にバックアップを作成してください');
  conn=peer.connect(id,{reliable:true});
  setupConn('send');
};

// バックアップ送信
function sendBackupData(){
  latestBackupBlob.arrayBuffer().then(buf=>{
    conn.send({type:'backup-file', name:latestBackupName, data:buf});
    appendLog('📤 '+latestBackupName+' を送信しました');
  });
}

// 受信処理
function receiveBackup(file){
  const blob=new Blob([file.data],{type:'application/octet-stream'});
  const url=URL.createObjectURL(blob);
  const div=document.createElement('div');
  div.textContent='📥 '+file.name+' を受信';
  const loadBtn=document.createElement('button');
  loadBtn.textContent='読み込む';
  loadBtn.className='load-btn';
  loadBtn.onclick=()=>loadBackupFromBlob(blob);
  div.appendChild(loadBtn);
  document.getElementById('recvList').appendChild(div);
  appendLog('📩 バックアップ受信完了: '+file.name);
}

// ローカルファイル読み込み
document.getElementById('loadLocalBtn').onclick=()=>{
  const file=document.getElementById('localFileInput').files[0];
  if(!file) return alert('ファイルを選択してください');
  loadBackupFromFile(file);
};

function loadBackupFromFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    loadBackupContent(e.target.result);
  };
  reader.readAsText(file);
}

function loadBackupFromBlob(blob){
  const reader=new FileReader();
  reader.onload=e=>loadBackupContent(e.target.result);
  reader.readAsText(blob);
}

function loadBackupContent(content){
  try{
    let memos;
    if(content.trim().startsWith("[")) memos=JSON.parse(content);
    else memos=JSON.parse(atob(content));
    localStorage.setItem("memos",JSON.stringify(memos));
    appendLog('✅ バックアップデータを読み込みました');
    alert("バックアップを読み込みました。ホームに戻って確認してください。");
  }catch(e){
    alert("読み込みに失敗しました: "+e.message);
  }
}
</script>
</body>
</html>
