<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>バックアップ - メモアプリ</title>
<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
body {
    font-family: "Segoe UI","Noto Sans JP",sans-serif;
    background:#f3f4f6; margin:0; padding:0;
}
.container {
    max-width:800px;
    width:90%;
    margin:40px auto;
    background:#fff;
    padding:24px;
    border-radius:12px;
    box-shadow:0 5px 20px rgba(0,0,0,0.1);
    display:flex; flex-direction:column; gap:20px;
    position:relative;
}
h1 { text-align:center; margin-bottom:20px; }
.mode { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; }
button {
    display:inline-block; padding:10px 16px; border:none; border-radius:8px;
    background:#0078d7; color:#fff; cursor:pointer; transition:0.2s;
    min-width:140px; height:40px; text-align:center;
}
button:hover { background:#005fa3; }
button.secondary { background:#ccc; color:#000; }
.hidden { display:none; }
.section { background:#f9fafb; border-radius:12px; padding:20px; display:flex; flex-direction:column; gap:10px; }
.status { margin-top:10px; padding:8px; border-radius:8px; background:#eee; font-size:14px; }
.status.ok { background:#d1fae5; color:#065f46; }
.status.wait { background:#fef3c7; color:#92400e; }
.status.err { background:#fee2e2; color:#991b1b; }
.info-btn { position:absolute; top:10px; right:10px; font-size:22px; background:transparent; color:#666; cursor:pointer; }
#infoModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; }
#infoContent { background:#fff; padding:20px; border-radius:12px; max-width:500px; line-height:1.6; }
#infoContent h2 { margin-top:0; }
#infoContent button { background:#0078d7; color:#fff; float:right; }
input[type="text"], input[type="file"] { width:100%; max-width:400px; padding:8px; border-radius:4px; border:1px solid #ccc; }
</style>
</head>
<body>
<div class="container">
    <button class="info-btn" id="infoBtn">ℹ️</button>
    <h1>💾 バックアップ転送</h1>

    <div class="mode">
        <button id="sendModeBtn">📤 送信モード</button>
        <button id="receiveModeBtn">📥 受信モード</button>
    </div>

    <div id="sendSection" class="section hidden">
        <h2>📤 送信モード</h2>
        <input type="text" id="peerIdInput" placeholder="受信側のPeerIDを入力">
        <button id="sendBackupBtn">バックアップ作成＆送信</button>
        <div id="sendStatus" class="status"></div>
    </div>

    <div id="receiveSection" class="section hidden">
        <h2>📥 受信モード</h2>
        <p>受信中のデータは自動で表示されます。</p>
        <div id="receiveStatus" class="status wait">待機中...</div>
        <div id="receivedFileArea" class="hidden">
            <p>受信完了: <b><span id="receivedFileName"></span></b></p>
            <button id="loadBackup">読み込み</button>
        </div>
        <hr>
        <p>またはローカルファイルから読み込む：</p>
        <input type="file" id="localFile">
    </div>

    <div style="text-align:center;margin-top:20px;">
        <button class="secondary" onclick="window.location.href='home.html'">🏠 ホームへ戻る</button>
    </div>
</div>

<!-- Info Modal -->
<div id="infoModal">
    <div id="infoContent">
        <h2>ℹ️ バックアップ転送の使い方</h2>
        <ul>
            <li>送信側：受信側のPeerIDを入力し、「バックアップ作成＆送信」を押す。</li>
            <li>受信側：自動受信。受信完了後、「読み込み」ボタンで復元。</li>
            <li>Wi-Fiが異なってもAbly経由で転送可能。</li>
            <li>ローカルファイルからの読み込みも可能。</li>
        </ul>
        <button id="closeInfo">閉じる</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ably/browser/static/ably.min.js"></script>
<script>
const ably = new Ably.Realtime("m4nEkQ.t_3fkw:CyxgDJS1Z5J8b6FAiCxkO1F-t7cLQGIxmfin9BzL");

// UI要素
const sendModeBtn = document.getElementById("sendModeBtn");
const receiveModeBtn = document.getElementById("receiveModeBtn");
const sendSection = document.getElementById("sendSection");
const receiveSection = document.getElementById("receiveSection");
const sendStatus = document.getElementById("sendStatus");
const peerIdInput = document.getElementById("peerIdInput");
const receiveStatus = document.getElementById("receiveStatus");
const receivedFileArea = document.getElementById("receivedFileArea");
const receivedFileName = document.getElementById("receivedFileName");
const loadBackupBtn = document.getElementById("loadBackup");
const localFileInput = document.getElementById("localFile");
let receivedData = null;

// モード切替
sendModeBtn.onclick = () => { sendSection.classList.remove("hidden"); receiveSection.classList.add("hidden"); };
receiveModeBtn.onclick = () => { receiveSection.classList.remove("hidden"); sendSection.classList.add("hidden"); };

// Infoモーダル
const infoBtn = document.getElementById("infoBtn");
const infoModal = document.getElementById("infoModal");
const closeInfo = document.getElementById("closeInfo");
infoBtn.onclick = () => infoModal.style.display="flex";
closeInfo.onclick = () => infoModal.style.display="none";
infoModal.onclick = e=>{ if(e.target===infoModal) infoModal.style.display="none"; };

// Peer生成（受信側も同じ）
const peer = new Peer();
peer.on('open', id => { console.log("Peer ready:", id); });

// 送信処理
document.getElementById("sendBackupBtn").onclick = async () => {
    const targetId = peerIdInput.value.trim();
    if(!targetId) return alert("受信側のPeerIDを入力してください");

    const data = JSON.stringify(localStorage);
    const fileName = "backup_" + new Date().toISOString().slice(0,10) + ".dat";

    const conn = peer.connect(targetId, { reliable:true });
    conn.on('open', ()=> {
        sendStatus.textContent = "送信中...";
        sendStatus.className = "status wait";
        conn.send({fileName, data});
        sendStatus.textContent = `✅ 送信完了 (${fileName})`;
        sendStatus.className = "status ok";
    });
    conn.on('error', ()=> {
        sendStatus.textContent = "❌ 送信に失敗しました";
        sendStatus.className = "status err";
    });
};

// 受信処理
peer.on('connection', conn => {
    receiveStatus.textContent = "受信中...";
    receiveStatus.className = "status wait";
    conn.on('data', msg => {
        receivedData = msg;
        receivedFileName.textContent = msg.fileName;
        receivedFileArea.classList.remove("hidden");
        receiveStatus.textContent = "✅ 受信完了";
        receiveStatus.className = "status ok";
    });
});

// 読み込み
loadBackupBtn.onclick = () => {
    if(!receivedData) return alert("データがありません");
    const json = JSON.parse(receivedData.data);
    for(const key in json) localStorage.setItem(key,json[key]);
    alert("バックアップを読み込みました。");
    window.location.href="home.html";
};

// ローカルファイル読み込み
localFileInput.addEventListener("change", e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
        const json = JSON.parse(reader.result);
        for(const key in json) localStorage.setItem(key,json[key]);
        alert("ローカルバックアップを読み込みました。");
        window.location.href="home.html";
    };
    reader.readAsText(file);
});
</script>
</body>
</html>
